<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Team Project Timeline Manager</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='0.9em' font-size='90'>üöÄ</text></svg>">
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        // ‚úÖ API Key ‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á (AIzaSyAKWEnv...) ‡πÄ‡∏ä‡πá‡∏Ñ‡πÅ‡∏•‡πâ‡∏ß 100%
        const firebaseConfig = {
            apiKey: "AIzaSyAKWEnv4kzNmcTGHri1_mF_iagsycIqXd8",
            authDomain: "benz-ab922.firebaseapp.com",
            projectId: "benz-ab922",
            storageBucket: "benz-ab922.firebasestorage.app",
            messagingSenderId: "746873956854",
            appId: "1:746873956854:web:02e72ef78ee58d05a73fd7",
            measurementId: "G-EBYCR340BL"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // --- Login Functions ---
        window.handleLogin = async function() {
            const email = document.getElementById('email').value;
            const pass = document.getElementById('password').value;
            if (!email || !pass) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å Email/Password");
            try {
                await signInWithEmailAndPassword(auth, email, pass);
            } catch (e) {
                alert("Login Error: " + e.message);
            }
        };

        window.handleLogout = function() {
            signOut(auth).then(() => window.location.reload());
        };

        onAuthStateChanged(auth, (user) => {
            if (user) {
                document.getElementById('loginOverlay').style.display = 'none';
                document.getElementById('mainContainer').style.display = 'block';
                document.getElementById('userDisplay').innerHTML = `üë§ ${user.email} | <span onclick="handleLogout()" style="cursor:pointer;text-decoration:underline;">Logout</span>`;
                window.currentUser = user.email;
                window.listenToCloud();
            } else {
                document.getElementById('loginOverlay').style.display = 'flex';
                document.getElementById('mainContainer').style.display = 'none';
            }
        });

        // --- Database Functions ---
        function getMachineID() {
            let mid = localStorage.getItem('timeline_mid');
            if(!mid) { mid = 'PC-' + Math.random().toString(36).substr(2,4).toUpperCase(); localStorage.setItem('timeline_mid', mid); }
            return mid;
        }

        window.saveToCloud = async function() {
            try {
                const data = {
                    projects: window.projects,
                    lastUpdated: new Date().toISOString(),
                    updatedBy: window.currentUser,
                    machine: getMachineID()
                };
                await setDoc(doc(db, "timeline", "projectData"), data);
                // showNotification('‚úÖ Saved!', 'success'); // ‡∏õ‡∏¥‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏£‡∏ö‡∏Å‡∏ß‡∏ô
            } catch (e) { console.error(e); }
        };

        window.listenToCloud = function() {
            onSnapshot(doc(db, "timeline", "projectData"), (doc) => {
                if(doc.exists()) {
                    const data = doc.data();
                    if(data.projects) {
                        window.projects = data.projects;
                        if(window.renderAll) window.renderAll();
                    }
                }
            });
        };
    </script>

    <style>
        /* --- PURPLE THEME CSS (‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡∏≤‡πÄ‡∏î‡∏¥‡∏°‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏ä‡∏≠‡∏ö) --- */
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', sans-serif; }
        body { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; color: #333; }
        
        /* Login Overlay */
        #loginOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 9999; display: flex; justify-content: center; align-items: center; }
        .login-box { background: white; padding: 40px; border-radius: 15px; width: 400px; text-align: center; box-shadow: 0 20px 50px rgba(0,0,0,0.5); }
        .login-box h2 { color: #333; margin-bottom: 20px; }
        .login-box input { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ddd; border-radius: 5px; }
        .login-btn { width: 100%; padding: 12px; background: #667eea; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; margin-top: 10px; }

        /* Main App */
        #mainContainer { display: none; max-width: 1600px; margin: 0 auto; background: rgba(255,255,255,0.95); border-radius: 20px; padding: 30px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); }
        
        /* Header */
        .app-header { background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 20px; border-radius: 15px; display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
        .app-header h1 { font-size: 24px; font-weight: bold; }
        .online-tag { background: #28a745; font-size: 12px; padding: 3px 8px; border-radius: 10px; vertical-align: middle; margin-left: 10px; }
        #userDisplay { font-size: 14px; background: rgba(255,255,255,0.2); padding: 5px 15px; border-radius: 20px; }

        /* Buttons & Controls */
        .btn { padding: 8px 16px; border: none; border-radius: 6px; cursor: pointer; color: white; font-size: 14px; transition: 0.2s; }
        .btn:hover { transform: translateY(-2px); opacity: 0.9; }
        .btn-green { background: #28a745; }
        .btn-purple { background: #667eea; }
        .btn-blue { background: #007bff; }
        .btn-red { background: #dc3545; }
        .btn-gray { background: #6c757d; }

        /* Project List */
        .project-section { background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 20px; border: 1px solid #eee; }
        .project-list { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 15px; }
        .proj-chip { display: flex; align-items: center; gap: 8px; padding: 8px 15px; background: white; border: 2px solid #ddd; border-radius: 8px; cursor: pointer; user-select: none; }
        .proj-chip.selected { border-color: #667eea; background: #eef2ff; }
        .dot { width: 12px; height: 12px; border-radius: 50%; }

        /* Stats */
        .stats-grid { display: flex; gap: 15px; margin-bottom: 20px; }
        .stat-box { flex: 1; background: white; padding: 15px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); text-align: center; }
        .stat-val { font-size: 24px; font-weight: bold; color: #333; margin-top: 5px; }
        .stat-label { font-size: 12px; color: #667eea; font-weight: bold; }

        /* Timeline Area */
        .timeline-box { background: white; border-radius: 10px; padding: 20px; overflow-x: auto; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .timeline-head { display: flex; border-bottom: 2px solid #667eea; padding-bottom: 10px; min-width: 1200px; position: sticky; top: 0; background: white; z-index: 50; }
        .col-name { width: 300px; font-weight: bold; padding-left: 10px; }
        .col-cal { flex: 1; display: flex; }
        .cal-cell { flex: 1; text-align: center; border-left: 1px solid #eee; font-size: 12px; color: #667eea; font-weight: bold; padding: 5px 0; }
        
        .proj-row-group { margin-top: 15px; border-left: 4px solid #ddd; padding-left: 10px; }
        .proj-name { font-weight: bold; padding: 5px; background: #f8f9fa; border-radius: 5px; display: flex; align-items: center; gap: 10px; }
        
        .task-row { display: flex; align-items: center; height: 50px; border-bottom: 1px solid #f9f9f9; min-width: 1200px; }
        .task-row:hover { background: #f8f9fa; }
        .task-meta { width: 300px; padding: 0 10px; font-size: 14px; display: flex; justify-content: space-between; align-items: center; }
        .task-bar-area { flex: 1; position: relative; height: 40px; display: flex; align-items: center; }
        
        .task-bar { position: absolute; height: 24px; border-radius: 12px; font-size: 11px; color: white; display: flex; align-items: center; justify-content: center; text-shadow: 0 1px 2px rgba(0,0,0,0.3); transition: 0.3s; }
        .p1 { background: linear-gradient(to right, #667eea, #764ba2); }
        .p2 { background: linear-gradient(to right, #f093fb, #f5576c); }
        .p3 { background: linear-gradient(to right, #4facfe, #00f2fe); }
        .p4 { background: linear-gradient(to right, #43e97b, #38f9d7); }
        .p5 { background: linear-gradient(to right, #fa709a, #fee140); }

        /* Modal */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 200; align-items: center; justify-content: center; }
        .modal-content { background: white; padding: 25px; border-radius: 10px; width: 450px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); }
        .form-row { margin-bottom: 15px; }
        .form-row label { display: block; margin-bottom: 5px; font-weight: bold; }
        .form-row input, .form-row select { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 5px; }
    </style>
</head>
<body>
    <div id="loginOverlay">
        <div class="login-box">
            <div style="font-size: 50px; margin-bottom: 10px;">üîí</div>
            <h2>Team Login</h2>
            <p style="color:#666; font-size:14px; margin-bottom:20px;">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</p>
            <input type="email" id="email" placeholder="Email">
            <input type="password" id="password" placeholder="Password">
            <button class="login-btn" onclick="handleLogin()">Login</button>
        </div>
    </div>

    <div id="mainContainer">
        <div class="app-header">
            <h1>üöÄ Team Project Timeline Manager <span class="online-tag">Online</span></h1>
            <div id="userDisplay"></div>
        </div>

        <div style="display:flex; justify-content:space-between; margin-bottom:20px;">
            <h2 style="color:#333;">Project Dashboard</h2>
            <div>
                <button class="btn btn-green" onclick="window.saveToCloud()">‚òÅÔ∏è Force Save</button>
            </div>
        </div>

        <div class="project-section">
            <h3>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏î‡∏π:</h3>
            <div class="project-list" id="projectList"></div>
            <div style="margin-top:15px; display:flex; gap:10px;">
                <button class="btn btn-purple" onclick="selectAll()">‚úÖ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
                <button class="btn btn-gray" onclick="deselectAll()">‚ùå ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                <button class="btn btn-blue" onclick="addNewProject()">‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà</button>
            </div>
        </div>

        <div class="project-section" style="display:flex; align-items:center; gap:10px;">
            <button class="btn btn-purple" id="vmMonth" onclick="setViewMode('month')">üìÖ ‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</button>
            <button class="btn btn-gray" id="vmWeek" onclick="setViewMode('week')">üìÜ ‡∏£‡∏≤‡∏¢‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå</button>
            <div style="flex:1"></div>
            <label>‡∏Å‡∏£‡∏≠‡∏á Phase:</label>
            <select id="phaseFilter" onchange="renderAll()" style="padding:5px; border-radius:5px;">
                <option value="all">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (All)</option>
                <option value="phase1">Phase 1</option>
                <option value="phase2">Phase 2</option>
                <option value="phase3">Phase 3</option>
                <option value="phase4">Phase 4</option>
                <option value="phase5">Phase 5</option>
            </select>
        </div>

        <div class="stats-grid">
            <div class="stat-box"><div class="stat-label">‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</div><div class="stat-val" id="st_proj">0</div></div>
            <div class="stat-box"><div class="stat-label">Tasks ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div><div class="stat-val" id="st_task">0</div></div>
            <div class="stat-box"><div class="stat-label">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏∑‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢</div><div class="stat-val" id="st_prog">0%</div></div>
            <div class="stat-box"><div class="stat-label">‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß</div><div class="stat-val" id="st_done">0</div></div>
        </div>

        <button class="btn btn-purple" style="margin-bottom:20px;" onclick="openTaskForm()">‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏° Task ‡πÉ‡∏´‡∏°‡πà</button>

        <div class="timeline-box">
            <div class="timeline-head">
                <div class="col-name">Project / Task Name</div>
                <div class="col-cal" id="calHeader"></div>
            </div>
            <div id="timelineBody"></div>
        </div>
        
        <div style="text-align:center; color:#999; font-size:12px; margin-top:20px;">
            Auto-Sync enabled with Firebase
        </div>
    </div>

    <div class="modal" id="taskModal" style="display:none;">
        <div class="modal-content">
            <h3 style="margin-bottom:20px;">üìù ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ Task</h3>
            <div class="form-row"><label>Project:</label><select id="inp_proj"></select></div>
            <div class="form-row"><label>Task Name:</label><input type="text" id="inp_name"></div>
            <div class="form-row"><label>Start:</label><input type="date" id="inp_start"></div>
            <div class="form-row"><label>End:</label><input type="date" id="inp_end"></div>
            <div class="form-row"><label>Phase:</label>
                <select id="inp_phase">
                    <option value="phase1">Phase 1</option>
                    <option value="phase2">Phase 2</option>
                    <option value="phase3">Phase 3</option>
                    <option value="phase4">Phase 4</option>
                    <option value="phase5">Phase 5</option>
                </select>
            </div>
            <div class="form-row"><label>Progress %:</label><input type="number" id="inp_prog" min="0" max="100"></div>
            <div style="display:flex; gap:10px; margin-top:20px;">
                <button class="btn btn-green" style="flex:1" onclick="saveTaskLocal()">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
                <button class="btn btn-gray" style="flex:1" onclick="closeModal()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
            </div>
        </div>
    </div>

    <script>
        // Data & State
        window.projects = [];
        window.selectedIds = new Set();
        let viewMode = 'month';
        let editMeta = null;
        const colors = ['#667eea', '#f093fb', '#4facfe', '#43e97b', '#fa709a', '#ff6b6b'];

        // --- Core Logic ---
        window.renderAll = function() {
            renderProjects();
            renderTimeline();
            updateStats();
        };

        function renderProjects() {
            const list = document.getElementById('projectList');
            list.innerHTML = '';
            window.projects.forEach((p, idx) => {
                const isSel = window.selectedIds.has(p.id);
                const d = document.createElement('div');
                d.className = `proj-chip ${isSel?'selected':''}`;
                d.innerHTML = `<div class="dot" style="background:${p.color}"></div><span>${p.name}</span><span style="color:red; margin-left:5px; font-size:10px;" onclick="event.stopPropagation(); delProj(${idx})">‚úñ</span>`;
                d.onclick = () => {
                    if(isSel) window.selectedIds.delete(p.id); else window.selectedIds.add(p.id);
                    renderAll();
                };
                list.appendChild(d);
            });
        }

        window.selectAll = () => { window.projects.forEach(p=>window.selectedIds.add(p.id)); renderAll(); };
        window.deselectAll = () => { window.selectedIds.clear(); renderAll(); };

        window.addNewProject = () => {
            const name = prompt("‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£:");
            if(name) {
                const pid = Date.now();
                window.projects.push({ id: pid, name: name, color: colors[window.projects.length%6], tasks: [] });
                window.selectedIds.add(pid);
                renderAll();
                if(window.saveToCloud) window.saveToCloud();
            }
        };

        window.delProj = (idx) => {
            if(confirm("‡∏•‡∏ö‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£?")) {
                window.projects.splice(idx, 1);
                renderAll();
                if(window.saveToCloud) window.saveToCloud();
            }
        };

        // --- Timeline ---
        function renderTimeline() {
            const header = document.getElementById('calHeader');
            const body = document.getElementById('timelineBody');
            header.innerHTML = ''; body.innerHTML = '';

            const range = { start: new Date('2025-01-01'), end: new Date('2025-12-31') };
            const totalDays = (range.end - range.start) / 86400000;

            // Header
            let curr = new Date(range.start);
            if(viewMode === 'month') {
                curr.setDate(1);
                while(curr <= range.end) {
                    const d = document.createElement('div');
                    d.className = 'cal-cell'; d.style.minWidth = '100px';
                    d.textContent = curr.toLocaleString('th-TH', { month: 'short' });
                    header.appendChild(d);
                    curr.setMonth(curr.getMonth()+1);
                }
            } else {
                curr.setDate(curr.getDate()-curr.getDay());
                while(curr <= range.end) {
                    const d = document.createElement('div');
                    d.className = 'cal-cell'; d.style.minWidth = '40px';
                    d.textContent = 'W' + Math.ceil((((curr - new Date(curr.getFullYear(),0,1))/86400000)+1)/7);
                    header.appendChild(d);
                    curr.setDate(curr.getDate()+7);
                }
            }

            // Body
            const active = window.projects.filter(p => window.selectedIds.has(p.id));
            const filter = document.getElementById('phaseFilter').value;

            active.forEach(p => {
                const group = document.createElement('div');
                group.className = 'proj-row-group';
                group.style.borderLeftColor = p.color;
                group.innerHTML = `<div class="proj-name"><div class="dot" style="background:${p.color}"></div>${p.name}</div>`;
                
                const tasks = filter==='all' ? p.tasks : p.tasks.filter(t=>t.phase===filter);
                tasks.forEach(t => {
                    const row = document.createElement('div');
                    row.className = 'task-row';
                    
                    const s = new Date(t.startDate);
                    const e = new Date(t.endDate);
                    const left = ((s - range.start)/86400000 / totalDays) * 100;
                    const w = ((e - s)/86400000 / totalDays) * 100;
                    
                    // Convert phase to class like 'p1', 'p2'
                    const phaseClass = t.phase.replace('phase', 'p');

                    row.innerHTML = `
                        <div class="task-meta">
                            <span>${t.name}</span>
                            <div>
                                <span style="cursor:pointer" onclick="editTask(${p.id}, '${t.id}')">‚úèÔ∏è</span>
                                <span style="cursor:pointer; color:red; margin-left:5px;" onclick="delTask(${p.id}, '${t.id}')">üóëÔ∏è</span>
                            </div>
                        </div>
                        <div class="task-bar-area">
                            <div style="position:absolute; width:1px; height:100%; background:#eee; left:0;"></div>
                            <div class="task-bar ${phaseClass}" style="left:${left}%; width:${Math.max(w,0.5)}%;">
                                ${t.progress}%
                            </div>
                        </div>
                    `;
                    group.appendChild(row);
                });
                if(tasks.length>0) body.appendChild(group);
            });
        }

        // --- Task CRUD ---
        window.openTaskForm = () => {
            editMeta = null;
            document.getElementById('taskModal').style.display = 'flex';
            document.getElementById('inp_name').value='';
            document.getElementById('inp_start').value='';
            document.getElementById('inp_end').value='';
            document.getElementById('inp_prog').value=0;
            updateSelect();
        };

        window.closeModal = () => document.getElementById('taskModal').style.display = 'none';

        function updateSelect() {
            const s = document.getElementById('inp_proj');
            s.innerHTML = '';
            window.projects.forEach(p => {
                const o = document.createElement('option');
                o.value = p.id; o.text = p.name; s.appendChild(o);
            });
        }

        window.saveTaskLocal = () => {
            const pid = document.getElementById('inp_proj').value;
            const task = {
                id: editMeta ? editMeta.tid : Date.now().toString(),
                name: document.getElementById('inp_name').value,
                startDate: document.getElementById('inp_start').value,
                endDate: document.getElementById('inp_end').value,
                phase: document.getElementById('inp_phase').value,
                progress: parseInt(document.getElementById('inp_prog').value)||0
            };
            
            if(!task.name) return alert("‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö");

            const p = window.projects.find(x => x.id == pid);
            if(editMeta) {
                if(editMeta.pid == pid) {
                    const idx = p.tasks.findIndex(t=>t.id==editMeta.tid);
                    p.tasks[idx] = task;
                } else {
                    // Move project logic could go here
                     const oldP = window.projects.find(x=>x.id == editMeta.pid);
                     oldP.tasks = oldP.tasks.filter(t=>t.id != editMeta.tid);
                     p.tasks.push(task);
                }
            } else {
                p.tasks.push(task);
            }
            
            closeModal();
            renderAll();
            if(window.saveToCloud) window.saveToCloud(); // Auto Save
        };

        window.editTask = (pid, tid) => {
            editMeta = {pid, tid};
            const p = window.projects.find(x=>x.id==pid);
            const t = p.tasks.find(x=>x.id==tid);
            
            document.getElementById('taskModal').style.display = 'flex';
            updateSelect();
            document.getElementById('inp_proj').value = pid;
            document.getElementById('inp_name').value = t.name;
            document.getElementById('inp_start').value = t.startDate;
            document.getElementById('inp_end').value = t.endDate;
            document.getElementById('inp_phase').value = t.phase;
            document.getElementById('inp_prog').value = t.progress;
        };

        window.delTask = (pid, tid) => {
            if(confirm("‡∏•‡∏ö‡∏á‡∏≤‡∏ô‡∏ô‡∏µ‡πâ?")) {
                const p = window.projects.find(x=>x.id==pid);
                p.tasks = p.tasks.filter(t=>t.id!=tid);
                renderAll();
                if(window.saveToCloud) window.saveToCloud(); // Auto Save
            }
        };

        window.setViewMode = (m) => {
            viewMode = m;
            document.getElementById('vmMonth').className = m=='month'?'view-btn active':'view-btn';
            document.getElementById('vmWeek').className = m=='week'?'view-btn active':'view-btn';
            renderAll();
        };

        function updateStats() {
            let pCnt=0, tCnt=0, progSum=0, done=0;
            const active = window.projects.filter(p=>window.selectedIds.has(p.id));
            pCnt = active.length;
            active.forEach(p => {
                p.tasks.forEach(t => {
                    tCnt++;
                    progSum += (t.progress||0);
                    if(t.progress>=100) done++;
                });
            });
            document.getElementById('st_proj').innerText = pCnt;
            document.getElementById('st_task').innerText = tCnt;
            document.getElementById('st_prog').innerText = (tCnt ? Math.round(progSum/tCnt) : 0) + '%';
            document.getElementById('st_done').innerText = done;
        }
    </script>
</body>
</html>
