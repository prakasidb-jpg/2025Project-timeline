<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Timeline Manager (Secure Login)</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='0.9em' font-size='90'>üîí</text></svg>">
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        // ‚úÖ ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç API Key ‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏≤‡∏°‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏•‡πâ‡∏ß
        const firebaseConfig = {
            apiKey: "AIzaSyAKWEnv4kzNmcTGHri1_mF_iagsycIqXd8",
            authDomain: "benz-ab922.firebaseapp.com",
            projectId: "benz-ab922",
            storageBucket: "benz-ab922.firebasestorage.app",
            messagingSenderId: "746873956854",
            appId: "1:746873956854:web:02e72ef78ee58d05a73fd7",
            measurementId: "G-EBYCR340BL"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // --- Auth Functions ---
        window.handleLogin = async function() {
            const email = document.getElementById('email').value;
            const pass = document.getElementById('password').value;
            try {
                await signInWithEmailAndPassword(auth, email, pass);
            } catch (error) {
                alert('‚ùå ‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô: ' + error.message);
            }
        };

        window.handleLogout = function() {
            signOut(auth).then(() => {
                window.location.reload();
            });
        };

        // Monitor Auth State
        onAuthStateChanged(auth, (user) => {
            if (user) {
                document.getElementById('loginOverlay').style.display = 'none';
                document.getElementById('appContent').style.display = 'block';
                document.getElementById('userInfo').textContent = `üë§ ${user.email}`;
                window.currentUserEmail = user.email;
                window.listenToCloud(); 
            } else {
                document.getElementById('loginOverlay').style.display = 'flex';
                document.getElementById('appContent').style.display = 'none';
            }
        });

        // --- Machine ID ---
        function getMachineID() {
            let machineId = localStorage.getItem('timeline_machine_id');
            if (!machineId) {
                const randomStr = Math.random().toString(36).substring(2, 6).toUpperCase();
                machineId = `Device-${randomStr}`;
                localStorage.setItem('timeline_machine_id', machineId);
            }
            return machineId;
        }

        // --- Cloud Save Function ---
        window.saveToCloud = async function() {
            try {
                showNotification('‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...', 'info');
                const machineID = getMachineID();
                const dataToSave = {
                    projects: window.projects,
                    lastUpdated: new Date().toISOString(),
                    updatedByDevice: machineID,
                    updatedByEmail: window.currentUserEmail
                };
                await setDoc(doc(db, "timeline", "projectData"), dataToSave);
                showNotification(`‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß!`, 'success');
            } catch (e) {
                console.error("Error: ", e);
                alert('‚ùå Error: ' + e.message);
            }
        };

        // --- Cloud Listen Function ---
        window.listenToCloud = function() {
            console.log("üì° Listening...");
            onSnapshot(doc(db, "timeline", "projectData"), (docSnapshot) => {
                if (docSnapshot.exists()) {
                    const data = docSnapshot.data();
                    if (data.projects) {
                        window.projects = data.projects;
                        if (window.renderProjectList) {
                            if(window.selectedProjectIds) {
                                window.projects.forEach(p => window.selectedProjectIds.add(p.id));
                            }
                            window.renderProjectList();
                            window.renderTimeline();
                            let msg = '‚òÅÔ∏è ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÅ‡∏•‡πâ‡∏ß';
                            if (data.updatedByEmail) msg += ` ‡πÇ‡∏î‡∏¢ ${data.updatedByEmail}`;
                            window.showNotification(msg, 'success');
                        }
                    }
                }
            });
        };
    </script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; }
        
        #loginOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); backdrop-filter: blur(5px); z-index: 9999; display: flex; justify-content: center; align-items: center; }
        .login-box { background: white; padding: 40px; border-radius: 15px; width: 100%; max-width: 400px; text-align: center; box-shadow: 0 20px 50px rgba(0,0,0,0.5); }
        .login-box input { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ddd; border-radius: 5px; }
        .login-btn { width: 100%; padding: 12px; background: #667eea; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; margin-top: 10px; }
        .login-btn:hover { background: #5a6fd6; }
        #appContent { display: none; }

        .container { max-width: 1800px; margin: 0 auto; background: rgba(255, 255, 255, 0.95);
