<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Timeline Manager</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='0.9em' font-size='90'>üìä</text></svg>">
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAKwENv4kzNmcTGHri1_mF_iagsycIqXd8",
            authDomain: "benz-ab922.firebaseapp.com",
            projectId: "benz-ab922",
            storageBucket: "benz-ab922.firebasestorage.app",
            messagingSenderId: "746873956854",
            appId: "1:746873956854:web:02e72ef78ee58d05a73fd7",
            measurementId: "G-EBYCR340BL"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        window.handleLogin = async function() {
            const email = document.getElementById('email').value;
            const pass = document.getElementById('password').value;
            if (!email || !pass) {
                alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å Email ‡πÅ‡∏•‡∏∞ Password');
                return;
            }
            try {
                await signInWithEmailAndPassword(auth, email, pass);
            } catch (error) {
                console.error(error);
                alert('Login Failed: ' + error.message);
            }
        };

        window.handleLogout = function() {
            signOut(auth).then(() => window.location.reload());
        };

        onAuthStateChanged(auth, (user) => {
            if (user) {
                document.getElementById('loginOverlay').style.display = 'none';
                document.getElementById('appContent').style.display = 'block';
                document.getElementById('userInfo').textContent = user.email;
                window.currentUserEmail = user.email;
                window.listenToCloud(); 
            } else {
                document.getElementById('loginOverlay').style.display = 'flex';
                document.getElementById('appContent').style.display = 'none';
            }
        });

        function getMachineID() {
            let machineId = localStorage.getItem('timeline_machine_id');
            if (!machineId) {
                const randomStr = Math.random().toString(36).substring(2, 6).toUpperCase();
                machineId = `Device-${randomStr}`;
                localStorage.setItem('timeline_machine_id', machineId);
            }
            return machineId;
        }

        window.saveToCloud = async function() {
            try {
                const machineID = getMachineID();
                const dataToSave = {
                    projects: window.projects,
                    lastUpdated: new Date().toISOString(),
                    updatedByDevice: machineID,
                    updatedByEmail: window.currentUserEmail
                };
                await setDoc(doc(db, "timeline", "projectData"), dataToSave);
                
                // Show toast notification
                const notif = document.createElement('div');
                notif.textContent = '‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢';
                notif.style.cssText = 'position:fixed;top:20px;right:20px;background:#28a745;color:white;padding:10px 20px;border-radius:5px;z-index:9999;';
                document.body.appendChild(notif);
                setTimeout(() => notif.remove(), 2000);
            } catch (e) {
                console.error("Save Error:", e);
            }
        };

        window.listenToCloud = function() {
            onSnapshot(doc(db, "timeline", "projectData"), (docSnapshot) => {
                if (docSnapshot.exists()) {
                    const data = docSnapshot.data();
                    if (data.projects) {
                        window.projects = data.projects;
                        if (window.renderProjectList) {
                            if(window.selectedProjectIds) {
                                window.projects.forEach(p => window.selectedProjectIds.add(p.id));
                            }
                            window.renderProjectList();
                            window.renderTimeline();
                        }
                    }
                }
            });
        };
    </script>

    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', sans-serif; }
        body { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; }
        
        #loginOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); backdrop-filter: blur(5px); z-index: 9999; display: flex; justify-content: center; align-items: center; }
        .login-box { background: white; padding: 40px; border-radius: 15px; width: 100%; max-width: 400px; text-align: center; box-shadow: 0 20px 50px rgba(0,0,0,0.5); }
        .login-box input { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ddd; border-radius: 5px; }
        .login-btn { width: 100%; padding: 12px; background: #667eea; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; margin-top: 10px; }
        .login-btn:hover { background: #5a6fd6; }
        
        #appContent { display: none; }
        .container { max-width: 1800px; margin: 0 auto; background: rgba(255, 255, 255, 0.95); border-radius: 20px; padding: 30px; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3); }
        
        h1 { color: #333; margin-bottom: 10px; font-size: 2em; }
        .header-info { background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 15px; border-radius: 10px; margin-bottom: 20px; text-align: center; }
        
        .project-selector, .view-controls, .task-form { background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 20px; }
        .project-list { display: flex; gap: 15px; flex-wrap: wrap; }
        .project-item { display: flex; align-items: center; gap: 8px; padding: 10px 15px; background: white; border: 2px solid #ddd; border-radius: 10px; cursor: pointer; }
        .project-item.selected { background: #667eea; color: white; border-color: #667eea; }
        .project-color { width: 20px; height: 20px; border-radius: 50%; border: 2px solid white; box-shadow: 0 1px 3px rgba(0,0,0,0.2); }
        
        .controls { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
        button { padding: 10px 20px; background: linear-gradient(135deg, #667eea, #764ba2); color: white; border: none; border-radius: 8px; cursor: pointer; }
        button:hover { transform: translateY(-2px); }
        
        .timeline-container { background: white; border-radius: 10px; padding: 20px; overflow-x: auto; margin-bottom: 20px; }
        .timeline-header { display: flex; border-bottom: 2px solid #667eea; padding-bottom: 10px; margin-bottom: 10px; min-width: 1400px; position: sticky; top: 0; background: white; z-index: 100; }
        .task-column { width: 350px; font-weight: bold; }
        .calendar-grid { flex: 1; display: flex; }
        .time-label { flex: 1; text-align: center; border-left: 1px solid #ddd; padding: 5px; font-size: 12px; min-width: 40px; }
        
        .task-row { display: flex; align-items: center; height: 55px; border-bottom: 1px solid #f0f0f0; min-width: 1400px; }
        .task-name { width: 350px; padding: 10px; font-size: 14px; display: flex; justify-content: space-between; }
        .task-timeline { flex: 1; position: relative; height: 45px; display: flex; align-items: center; }
        
        .task-bar-container { position: absolute; height: 40px; background: rgba(200,200,200,0.3); border-radius: 20px; overflow: visible; border: 1px solid #ddd; }
        .task-bar { height: 100%; border-radius: 20px; }
        .task-bar.phase1 { background: linear-gradient(135deg, #667eea, #764ba2); }
        .task-bar.phase2 { background: linear-gradient(135deg, #f093fb, #f5576c); }
        .task-bar.phase3 { background: linear-gradient(135deg, #4facfe, #00f2fe); }
        .task-bar.phase4 { background: linear-gradient(135deg, #43e97b, #38f9d7); }
        .task-bar.phase5 { background: linear-gradient(135deg, #fa709a, #fee140); }
        
        .task-bar-label { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: white; font-weight: bold; text-shadow: 0 1px 2px rgba(0,0,0,0.5); font-size: 12px; }
        .task-duration { position: absolute; top: -18px; left: 0; font-size: 10px; color: #666; }
        
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: bold; }
        .form-group input, .form-group select { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 5px; }
        
        .online-badge { background: #28a745; color: white; padding: 2px 8px; border-radius: 10px; font-size: 12px; margin-left: 10px; }
        .stats-panel { display: flex; gap: 15px; margin-bottom: 20px; flex-wrap: wrap; }
        .stat-card { background: white; padding: 15px; border-radius: 10px; flex: 1; min-width: 150px; text-align: center; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .stat-card .val { font-size: 20px; font-weight: bold; color: #333; }
    </style>
</head>
<body>
    <div id="loginOverlay">
        <div class="login-box">
            <div style="font-size: 60px; margin-bottom: 10px;">üîí</div>
            <h2>Team Login</h2>
            <p style="color:#666; margin-bottom:20px;">Timeline Manager System</p>
            <input type="email" id="email" placeholder="Email">
            <input type="password" id="password" placeholder="Password">
            <button class="login-btn" onclick="handleLogin()">Login</button>
        </div>
    </div>

    <div id="appContent" class="container">
        <div class="header-info">
            <h2>üöÄ Timeline Manager <span class="online-badge">Online</span></h2>
            <div style="margin-top:10px;">
                <span id="userInfo"></span> | 
                <button onclick="handleLogout()" style="padding:5px 10px; font-size:12px; border:1px solid white; background:transparent;">Logout</button>
            </div>
        </div>

        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
            <h1>Dashboard</h1>
            <button onclick="window.saveToCloud()" style="background: linear-gradient(135deg, #11998e, #38ef7d);">‚òÅÔ∏è Force Save</button>
        </div>

        <div class="stats-panel">
            <div class="stat-card">Tasks ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î<div class="val" id="st_total">0</div></div>
            <div class="stat-card">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥<div class="val" id="st_progress">0</div></div>
            <div class="stat-card">‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß<div class="val" id="st_done">0</div></div>
        </div>

        <div class="project-selector">
            <h3>Projects:</h3>
            <div class="project-list" id="projectList"></div>
            <div style="margin-top:10px;">
                <button onclick="selectAll()">Select All</button>
                <button onclick="addNewProject()">+ New Project</button>
            </div>
        </div>

        <div class="view-controls">
            <button onclick="setViewMode('month')">Month View</button>
            <button onclick="setViewMode('week')">Week View</button>
            <button onclick="zoomOut()">- Zoom</button>
            <button onclick="zoomIn()">+ Zoom</button>
            <span style="margin-left:10px;">Filter Phase:</span>
            <select id="phaseFilter" onchange="applyFilter()" style="padding:5px;">
                <option value="all">All</option>
                <option value="phase1">Phase 1</option>
                <option value="phase2">Phase 2</option>
                <option value="phase3">Phase 3</option>
                <option value="phase4">Phase 4</option>
                <option value="phase5">Phase 5</option>
            </select>
        </div>

        <div class="controls">
            <button onclick="addTask()">+ New Task</button>
        </div>

        <div class="timeline-container">
            <div class="timeline-header">
                <div class="task-column">Task Name</div>
                <div class="calendar-grid" id="calendarHeader"></div>
            </div>
            <div id="taskList"></div>
        </div>

        <div class="task-form" id="taskForm" style="display:none;">
            <h3>Task Details</h3>
            <div class="form-group"><label>Project:</label><select id="t_project"></select></div>
            <div class="form-group"><label>Name:</label><input type="text" id="t_name"></div>
            <div class="form-group"><label>Start:</label><input type="date" id="t_start"></div>
            <div class="form-group"><label>End:</label><input type="date" id="t_end"></div>
            <div class="form-group"><label>Phase:</label>
                <select id="t_phase">
                    <option value="phase1">Phase 1</option>
                    <option value="phase2">Phase 2</option>
                    <option value="phase3">Phase 3</option>
                    <option value="phase4">Phase 4</option>
                    <option value="phase5">Phase 5</option>
                </select>
            </div>
            <div class="form-group"><label>Progress %:</label><input type="number" id="t_progress" min="0" max="100"></div>
            <button onclick="saveTaskLocal()">Save Task</button>
            <button onclick="document.getElementById('taskForm').style.display='none'" style="background:#666;">Cancel</button>
        </div>
    </div>

    <script>
        window.projects = [];
        window.selectedIds = new Set();
        let editTaskMeta = null;
        let viewMode = 'month';
        let zoom = 100;
        let filter = 'all';
        const colors = ['#667eea', '#f093fb', '#4facfe', '#43e97b', '#fa709a'];

        function init() {
            renderProjects();
            renderTimeline();
        }

        // --- Render Projects ---
        window.renderProjects = function() {
            const list = document.getElementById('projectList');
            list.innerHTML = '';
            window.projects.forEach((p, idx) => {
                const div = document.createElement('div');
                div.className = `project-item ${window.selectedIds.has(p.id)?'selected':''}`;
                div.innerHTML = `
                    <span onclick="toggleProj(${p.id})">${p.name}</span>
                    <span style="font-size:10px; cursor:pointer;" onclick="delProj(${idx})">‚ùå</span>
                `;
                list.appendChild(div);
            });
            updateSelect();
        };

        window.toggleProj = function(id) {
            if(window.selectedIds.has(id)) window.selectedIds.delete(id);
            else window.selectedIds.add(id);
            renderProjects(); renderTimeline();
        };
        window.selectAll = function() {
            window.projects.forEach(p => window.selectedIds.add(p.id));
            renderProjects(); renderTimeline();
        };

        // --- CRUD Logic + AUTO SAVE ---
        window.addNewProject = function() {
            const name = prompt("Project Name:");
            if(name) {
                const pid = Date.now();
                window.projects.push({id: pid, name: name, color: colors[window.projects.length%5], tasks:[]});
                window.selectedIds.add(pid);
                renderProjects();
                if(window.saveToCloud) window.saveToCloud(); // Auto Save
            }
        };

        window.delProj = function(idx) {
            if(confirm("Delete Project?")) {
                window.projects.splice(idx, 1);
                renderProjects(); renderTimeline();
                if(window.saveToCloud) window.saveToCloud(); // Auto Save
            }
        };

        window.addTask = function() {
            editTaskMeta = null;
            document.getElementById('taskForm').style.display='block';
            document.getElementById('t_name').value='';
            document.getElementById('t_start').value='';
            document.getElementById('t_end').value='';
            document.getElementById('t_progress').value=0;
            updateSelect();
        };

        window.editTask = function(pid, tid) {
            const p = window.projects.find(x=>x.id==pid);
            const t = p.tasks.find(x=>x.id==tid);
            editTaskMeta = {pid, tid};
            document.getElementById('taskForm').style.display='block';
            document.getElementById('t_project').value=pid;
            document.getElementById('t_name').value=t.name;
            document.getElementById('t_start').value=t.startDate;
            document.getElementById('t_end').value=t.endDate;
            document.getElementById('t_phase').value=t.phase;
            document.getElementById('t_progress').value=t.progress;
            updateSelect();
        };

        window.delTask = function(pid, tid) {
            if(confirm("Delete Task?")) {
                const p = window.projects.find(x=>x.id==pid);
                p.tasks = p.tasks.filter(x=>x.id != tid);
                renderTimeline();
                if(window.saveToCloud) window.saveToCloud(); // Auto Save
            }
        };

        window.saveTaskLocal = function() {
            const pid = document.getElementById('t_project').value;
            const tObj = {
                id: editTaskMeta ? editTaskMeta.tid : Date.now().toString(),
                name: document.getElementById('t_name').value,
                startDate: document.getElementById('t_start').value,
                endDate: document.getElementById('t_end').value,
                phase: document.getElementById('t_phase').value,
                progress: parseInt(document.getElementById('t_progress').value) || 0
            };

            if(!tObj.name || !tObj.startDate || !tObj.endDate) return alert("‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö");

            const p = window.projects.find(x => x.id == pid);
            if(editTaskMeta) {
                // Edit
                if(editTaskMeta.pid == pid) {
                    const idx = p.tasks.findIndex(x=>x.id == editTaskMeta.tid);
                    p.tasks[idx] = tObj;
                } else {
                    // Move project
                    const oldP = window.projects.find(x=>x.id == editTaskMeta.pid);
                    oldP.tasks = oldP.tasks.filter(x=>x.id != editTaskMeta.tid);
                    p.tasks.push(tObj);
                }
            } else {
                // New
                p.tasks.push(tObj);
            }

            document.getElementById('taskForm').style.display='none';
            renderTimeline();
            if(window.saveToCloud) window.saveToCloud(); // Auto Save Triggered!
        };

        function updateSelect() {
            const s = document.getElementById('t_project');
            s.innerHTML = '';
            window.projects.forEach(p => {
                const opt = document.createElement('option');
                opt.value = p.id;
                opt.text = p.name;
                s.appendChild(opt);
            });
            if(editTaskMeta) s.value = editTaskMeta.pid;
        }

        // --- Timeline Core ---
        window.renderTimeline = function() {
            const h = document.getElementById('calendarHeader');
            const l = document.getElementById('taskList');
            h.innerHTML=''; l.innerHTML='';

            // Stats Logic
            let tot=0, prog=0, done=0;

            const range = getDateRange();
            const days = (range.end - range.start)/(1000*60*60*24);

            // Render Header
            let curr = new Date(range.start);
            if(viewMode === 'week') {
                curr.setDate(curr.getDate()-curr.getDay());
                while(curr <= range.end) {
                    const d = document.createElement('div');
                    d.className = 'time-label';
                    d.style.minWidth = (40*zoom/100)+'px';
                    d.textContent = 'W'+getWeek(curr);
                    h.appendChild(d);
                    curr.setDate(curr.getDate()+7);
                }
            } else {
                curr.setDate(1);
                while(curr <= range.end) {
                    const d = document.createElement('div');
                    d.className = 'time-label';
                    d.style.minWidth = (100*zoom/100)+'px';
                    d.textContent = curr.toLocaleString('default', {month:'short', year:'2-digit'});
                    h.appendChild(d);
                    curr.setMonth(curr.getMonth()+1);
                }
            }

            // Render Tasks
            const showP = window.projects.filter(p => window.selectedIds.has(p.id));
            showP.forEach(p => {
                const ts = filter==='all' ? p.tasks : p.tasks.filter(t=>t.phase===filter);
                ts.forEach(t => {
                    tot++;
                    if(t.progress>=100) done++; else if(t.progress>0) prog++;

                    const r = document.createElement('div');
                    r.className='task-row';
                    r.innerHTML = `
                        <div class="task-name">
                            <span>${t.name}</span>
                            <div>
                                <span style="font-size:10px; cursor:pointer;" onclick="editTask(${p.id}, '${t.id}')">‚úèÔ∏è</span>
                                <span style="font-size:10px; cursor:pointer;" onclick="delTask(${p.id}, '${t.id}')">üóëÔ∏è</span>
                            </div>
                        </div>
                    `;
                    
                    const tl = document.createElement('div');
                    tl.className='task-timeline';
                    
                    // Grid lines (simplified)
                    const s = new Date(t.startDate);
                    const e = new Date(t.endDate);
                    const left = ((s - range.start)/(1000*60*60*24) / days) * 100;
                    const w = ((e - s)/(1000*60*60*24) / days) * 100;

                    const bar = document.createElement('div');
                    bar.className = `task-bar-container`;
                    bar.style.left = left+'%';
                    bar.style.width = Math.max(w, 0.5)+'%';
                    bar.innerHTML = `
                        <div class="task-bar ${t.phase}" style="width:${t.progress}%"></div>
                        <div class="task-bar-label">${t.progress}%</div>
                    `;
                    
                    tl.appendChild(bar);
                    r.appendChild(tl);
                    l.appendChild(r);
                });
            });

            // Update Stats UI
            document.getElementById('st_total').innerText = tot;
            document.getElementById('st_progress').innerText = prog;
            document.getElementById('st_done').innerText = done;
        };

        function getDateRange() {
            let s = new Date('2025-01-01');
            let e = new Date('2025-12-31');
            // Simplified range logic to prevent errors on empty projects
            return {start:s, end:e}; 
        }
        function getWeek(d) {
            const onejan = new Date(d.getFullYear(),0,1);
            return Math.ceil((((d - onejan) / 86400000) + onejan.getDay()+1)/7);
        }

        window.setViewMode = (m) => { viewMode=m; renderTimeline(); };
        window.zoomIn = () => { if(zoom<200) zoom+=20; renderTimeline(); };
        window.zoomOut = () => { if(zoom>50) zoom-=20; renderTimeline(); };
        window.applyFilter = () => { filter = document.getElementById('phaseFilter').value; renderTimeline(); };

    </script>
</body>
</html>
