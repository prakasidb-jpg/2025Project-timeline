<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sales Dashboard - Online (Firebase)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/pptxgenjs@3.12.0/dist/pptxgen.bundle.js"></script>

    <script type="module">
        // Import Firebase modules from CDN
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // Configuration from your image
        const firebaseConfig = {
            apiKey: "AIzaSyAKWEnv4kzNmcTGHri1_mF_iagsycIqXd8",
            authDomain: "benz-ab922.firebaseapp.com",
            projectId: "benz-ab922",
            storageBucket: "benz-ab922.firebasestorage.app",
            messagingSenderId: "746873956854",
            appId: "1:746873956854:web:02e72ef78ee58d05a73fd7",
            measurementId: "G-EBYCR340BL"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        console.log("üî• Firebase initialized:", app.name);

        // Expose functions to global window object so standard JS can use them
        window.saveToFirebase = async function(data) {
            try {
                await setDoc(doc(db, "dashboard", "mainData"), data);
                // alert('‚úÖ Saved to Cloud successfully!'); // Optional alert
                return true;
            } catch (e) {
                console.error("Error adding document: ", e);
                alert('‚ùå Error saving to Cloud: ' + e.message);
                return false;
            }
        };

        window.listenToFirebase = function() {
            console.log("üì° Listening to Firebase updates...");
            onSnapshot(doc(db, "dashboard", "mainData"), (docSnapshot) => {
                if (docSnapshot.exists()) {
                    const data = docSnapshot.data();
                    console.log("‚òÅÔ∏è Data received from Cloud");
                    if (window.updateLocalDataFromCloud) {
                        window.updateLocalDataFromCloud(data);
                    }
                } else {
                    console.log("No such document in Cloud yet.");
                }
            });
        };

        // Start listening immediately
        window.listenToFirebase();
    </script>
    <style>
        .tab-button { transition: all 0.3s ease; }
        .card { transition: transform 0.3s ease, box-shadow 0.3s ease; }
        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
        }
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        @keyframes slideOut {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }
        .dropdown { position: relative; display: inline-block; }
        .dropdown-content {
            display: none;
            position: absolute;
            background-color: white;
            min-width: 220px;
            box-shadow: 0 8px 16px rgba(0,0,0,0.2);
            border-radius: 8px;
            z-index: 1000;
            margin-top: 4px;
        }
        .dropdown-content a {
            color: #374151;
            padding: 12px 16px;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: background-color 0.2s;
        }
        .dropdown-content a:hover { background-color: #f3f4f6; }
        .dropdown-content a:first-child { border-radius: 8px 8px 0 0; }
        .dropdown-content a:last-child { border-radius: 0 0 8px 8px; }
        .dropdown:hover .dropdown-content { display: block; }
        .dropdown-separator { 
            height: 1px; 
            background-color: #e5e7eb; 
            margin: 4px 0; 
        }
    </style>
</head>
<body class="bg-gradient-to-br from-gray-50 to-gray-100 min-h-screen">
    <div class="max-w-7xl mx-auto p-6">
        <div class="mb-8">
            <div class="flex justify-between items-center">
                <div>
                    <h1 class="text-4xl font-bold text-gray-800 mb-2">Sales Dashboard <span class="text-sm bg-green-100 text-green-800 px-2 py-1 rounded-full align-middle">Online</span></h1>
                    <p class="text-gray-600">By Prakasid Banchuen (Benz)</p>
                </div>
                <div class="flex gap-3">
                    <button onclick="backupAllData()" class="px-6 py-3 bg-purple-500 text-white rounded-lg hover:bg-purple-600 transition-all shadow-lg flex items-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M9 19l3 3m0 0l3-3m-3 3V10"></path>
                        </svg>
                        Backup All
                    </button>
                    <label class="px-6 py-3 bg-indigo-500 text-white rounded-lg hover:bg-indigo-600 transition-all shadow-lg flex items-center gap-2 cursor-pointer">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                        </svg>
                        Restore Backup
                        <input type="file" accept=".json" onchange="restoreFromBackup(event)" class="hidden" />
                    </label>
                    <button onclick="saveData()" class="px-6 py-3 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-all shadow-lg flex items-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4"></path>
                        </svg>
                        Save to Cloud
                    </button>
                    <button onclick="clearData()" class="px-6 py-3 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-all shadow-lg flex items-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                        </svg>
                        Clear Data
                    </button>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-xl shadow-lg mb-6 p-2">
            <div class="flex gap-2 flex-wrap">
                <button onclick="showTab('dashboard')" id="tab-dashboard" class="tab-button px-6 py-3 rounded-lg font-medium bg-blue-500 text-white">Dashboard</button>
                <button onclick="showTab('comparison')" id="tab-comparison" class="tab-button px-6 py-3 rounded-lg font-medium text-gray-700 hover:bg-gray-100">üîÑ Comparison</button>
                <button onclick="showTab('data')" id="tab-data" class="tab-button px-6 py-3 rounded-lg font-medium text-gray-700 hover:bg-gray-100">Sales Data</button>
                <button onclick="showTab('prices')" id="tab-prices" class="tab-button px-6 py-3 rounded-lg font-medium text-gray-700 hover:bg-gray-100">Standard Prices</button>
                <button onclick="showTab('customers')" id="tab-customers" class="tab-button px-6 py-3 rounded-lg font-medium text-gray-700 hover:bg-gray-100">Customers</button>
                <button onclick="showTab('industry')" id="tab-industry" class="tab-button px-6 py-3 rounded-lg font-medium text-gray-700 hover:bg-gray-100">Industry</button>
                <button onclick="showTab('profit')" id="tab-profit" class="tab-button px-6 py-3 rounded-lg font-medium text-gray-700 hover:bg-gray-100">Profit</button>
            </div>
        </div>

        <div id="content-dashboard" class="space-y-6">
            <div class="bg-white rounded-xl shadow-lg p-6">
                <h3 class="text-lg font-semibold text-gray-800 mb-4">üîç Filter Data</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4 mb-4">
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">‡πÄ‡∏î‡∏∑‡∏≠‡∏ô (Month)</label>
                        <select id="filterMonth" onchange="applyFilters()" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            <option value="all">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (All)</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (Product Type)</label>
                        <select id="filterProductType" onchange="applyFilters()" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            <option value="all">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (All)</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">‡∏≠‡∏∏‡∏ï‡∏™‡∏≤‡∏´‡∏Å‡∏£‡∏£‡∏° (Industry)</label>
                        <select id="filterIndustry" onchange="applyFilters()" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            <option value="all">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (All)</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">‡∏ï‡∏•‡∏≤‡∏î (Market)</label>
                        <select id="filterMarket" onchange="applyFilters()" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            <option value="all">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (All)</option>
                            <option value="Domestic">‡∏†‡∏≤‡∏¢‡πÉ‡∏ô‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏® (Domestic)</option>
                            <option value="Export">‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å (Export)</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Ç‡∏≤‡∏¢ (Sales Person)</label>
                        <select id="filterSalesPerson" onchange="applyFilters()" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            <option value="all">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (All)</option>
                        </select>
                    </div>
                </div>
                <div class="flex gap-3">
                    <button onclick="resetFilters()" class="px-6 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition-all">üîÑ Reset</button>
                    <button onclick="applyFilters()" class="px-6 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-all">‚úì Apply Filters</button>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                <div class="card bg-gradient-to-br from-blue-500 to-blue-600 rounded-xl p-6 text-white shadow-lg">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-blue-100 text-sm font-medium">Total Revenue</p>
                            <p id="totalRevenue" class="text-3xl font-bold mt-2">‡∏ø0.00M</p>
                        </div>
                        <svg class="w-12 h-12 text-blue-200" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path>
                        </svg>
                    </div>
                </div>
                <div class="card bg-gradient-to-br from-green-500 to-green-600 rounded-xl p-6 text-white shadow-lg">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-green-100 text-sm font-medium">Total Quantity</p>
                            <p id="totalQty" class="text-3xl font-bold mt-2">0</p>
                        </div>
                        <svg class="w-12 h-12 text-green-200" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                        </svg>
                    </div>
                </div>
                <div class="card bg-gradient-to-br from-purple-500 to-purple-600 rounded-xl p-6 text-white shadow-lg">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-purple-100 text-sm font-medium">Total Orders</p>
                            <p id="totalOrders" class="text-3xl font-bold mt-2">0</p>
                        </div>
                        <svg class="w-12 h-12 text-purple-200" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M3 14h18m-9-4v8m-7 0h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                        </svg>
                    </div>
                </div>
                <div class="card bg-gradient-to-br from-orange-500 to-orange-600 rounded-xl p-6 text-white shadow-lg">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-orange-100 text-sm font-medium">Avg Order Value</p>
                            <p id="avgOrderValue" class="text-3xl font-bold mt-2">‡∏ø0</p>
                        </div>
                        <svg class="w-12 h-12 text-orange-200" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-xl shadow-lg p-6">
                <h3 class="text-lg font-semibold text-gray-800 mb-4">Select Charts to Display</h3>
                <div class="space-y-3">
                    <label class="flex items-center p-4 border-2 border-blue-200 rounded-lg cursor-pointer hover:bg-blue-50 transition-all">
                        <input type="checkbox" id="chartMonthlyRevenue" onchange="toggleDashboardChart('monthlyRevenue')" checked class="w-5 h-5 text-blue-600 rounded focus:ring-2 focus:ring-blue-500">
                        <div class="ml-3">
                            <p class="font-semibold text-gray-800">üìà Monthly Revenue Trend</p>
                            <p class="text-sm text-gray-600">Revenue over time</p>
                        </div>
                    </label>
                    <label class="flex items-center p-4 border-2 border-gray-200 rounded-lg cursor-pointer hover:bg-gray-50 transition-all">
                        <input type="checkbox" id="chartProductType" onchange="toggleDashboardChart('productType')" class="w-5 h-5 text-blue-600 rounded focus:ring-2 focus:ring-blue-500">
                        <div class="ml-3">
                            <p class="font-semibold text-gray-800">üé® Product Type Distribution</p>
                            <p class="text-sm text-gray-600">Sales by product type</p>
                        </div>
                    </label>
                    <label class="flex items-center p-4 border-2 border-gray-200 rounded-lg cursor-pointer hover:bg-gray-50 transition-all">
                        <input type="checkbox" id="chartMarketBreakdown" onchange="toggleDashboardChart('marketBreakdown')" class="w-5 h-5 text-blue-600 rounded focus:ring-2 focus:ring-blue-500">
                        <div class="ml-3">
                            <p class="font-semibold text-gray-800">üåç Market Breakdown</p>
                            <p class="text-sm text-gray-600">Domestic vs Export</p>
                        </div>
                    </label>
                    <label class="flex items-center p-4 border-2 border-gray-200 rounded-lg cursor-pointer hover:bg-gray-50 transition-all">
                        <input type="checkbox" id="chartTopCustomers" onchange="toggleDashboardChart('topCustomers')" class="w-5 h-5 text-blue-600 rounded focus:ring-2 focus:ring-blue-500">
                        <div class="ml-3">
                            <p class="font-semibold text-gray-800">üë• Top 10 Customers</p>
                            <p class="text-sm text-gray-600">Best customers</p>
                        </div>
                    </label>
                    <label class="flex items-center p-4 border-2 border-gray-200 rounded-lg cursor-pointer hover:bg-gray-50 transition-all">
                        <input type="checkbox" id="chartSalesTeam" onchange="toggleDashboardChart('salesTeam')" class="w-5 h-5 text-blue-600 rounded focus:ring-2 focus:ring-blue-500">
                        <div class="ml-3">
                            <p class="font-semibold text-gray-800">üë®‚Äçüíº Sales Team Performance</p>
                            <p class="text-sm text-gray-600">Performance by salesperson</p>
                        </div>
                    </label>
                    <label class="flex items-center p-4 border-2 border-gray-200 rounded-lg cursor-pointer hover:bg-gray-50 transition-all">
                        <input type="checkbox" id="chartTopProducts" onchange="toggleDashboardChart('topProducts')" class="w-5 h-5 text-blue-600 rounded focus:ring-2 focus:ring-blue-500">
                        <div class="ml-3">
                            <p class="font-semibold text-gray-800">‚≠ê Top 10 Products</p>
                            <p class="text-sm text-gray-600">Best selling products</p>
                        </div>
                    </label>
                </div>
            </div>

            <div id="dashboardChartsContainer" class="space-y-6"></div>

            <div id="chart-monthlyRevenue" class="bg-white rounded-xl shadow-lg p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold text-gray-800">üìà Monthly Revenue Trend</h3>
                    <label class="flex items-center gap-2 cursor-pointer">
                        <input type="checkbox" id="showDashMonthlyValues" onchange="toggleDashboardChartLabels('dashMonthlyRevenueChart')" checked class="w-5 h-5 text-blue-600 rounded focus:ring-2 focus:ring-blue-500">
                        <span class="text-sm font-medium text-gray-700">Show Values</span>
                    </label>
                </div>
                <div style="position: relative; height: 400px;">
                    <canvas id="dashMonthlyRevenueChart"></canvas>
                </div>
            </div>

            <div id="chart-productType" class="bg-white rounded-xl shadow-lg p-6" style="display:none;">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold text-gray-800">üé® Product Type Distribution</h3>
                    <label class="flex items-center gap-2 cursor-pointer">
                        <input type="checkbox" id="showProductTypeValues" onchange="toggleDashboardChartLabels('dashProductTypeChart')" checked class="w-5 h-5 text-blue-600 rounded focus:ring-2 focus:ring-blue-500">
                        <span class="text-sm font-medium text-gray-700">Show Values</span>
                    </label>
                </div>
                <div style="position: relative; height: 400px;">
                    <canvas id="dashProductTypeChart"></canvas>
                </div>
            </div>

            <div id="chart-marketBreakdown" class="bg-white rounded-xl shadow-lg p-6" style="display:none;">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold text-gray-800">üåç Market Breakdown</h3>
                </div>
                <div style="position: relative; height: 400px;">
                    <canvas id="dashMarketChart"></canvas>
                </div>
            </div>

            <div id="chart-topCustomers" class="bg-white rounded-xl shadow-lg p-6" style="display:none;">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold text-gray-800">üë• Top 10 Customers</h3>
                    <label class="flex items-center gap-2 cursor-pointer">
                        <input type="checkbox" id="showTopCustomersValues" onchange="toggleDashboardChartLabels('dashTopCustomersChart')" checked class="w-5 h-5 text-blue-600 rounded focus:ring-2 focus:ring-blue-500">
                        <span class="text-sm font-medium text-gray-700">Show Values</span>
                    </label>
                </div>
                <div style="position: relative; height: 400px;">
                    <canvas id="dashTopCustomersChart"></canvas>
                </div>
            </div>

            <div id="chart-salesTeam" class="bg-white rounded-xl shadow-lg p-6" style="display:none;">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold text-gray-800">üë®‚Äçüíº Sales Team Performance</h3>
                    <label class="flex items-center gap-2 cursor-pointer">
                        <input type="checkbox" id="showSalesTeamValues" onchange="toggleDashboardChartLabels('dashSalesTeamChart')" checked class="w-5 h-5 text-blue-600 rounded focus:ring-2 focus:ring-blue-500">
                        <span class="text-sm font-medium text-gray-700">Show Values</span>
                    </label>
                </div>
                <div style="position: relative; height: 400px;">
                    <canvas id="dashSalesTeamChart"></canvas>
                </div>
            </div>

            <div id="chart-topProducts" class="bg-white rounded-xl shadow-lg p-6" style="display:none;">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold text-gray-800">‚≠ê Top 10 Products</h3>
                    <label class="flex items-center gap-2 cursor-pointer">
                        <input type="checkbox" id="showTopProductsValues" onchange="toggleDashboardChartLabels('dashTopProductsChart')" checked class="w-5 h-5 text-blue-600 rounded focus:ring-2 focus:ring-blue-500">
                        <span class="text-sm font-medium text-gray-700">Show Values</span>
                    </label>
                </div>
                <div style="position: relative; height: 400px;">
                    <canvas id="dashTopProductsChart"></canvas>
                </div>
            </div>
        </div>

        <div id="content-comparison" class="space-y-6" style="display:none;">
            <div class="bg-white rounded-xl shadow-lg p-6">
                <h3 class="text-lg font-semibold text-gray-800 mb-4">üìã CSV Template</h3>
                <div class="flex gap-3">
                    <button onclick="downloadTemplate('comparison')" class="px-6 py-2 bg-purple-500 text-white rounded-lg hover:bg-purple-600 transition-all">üì• Download Template</button>
                    <button onclick="showTemplatePreview('comparison')" class="px-6 py-2 bg-orange-500 text-white rounded-lg hover:bg-orange-600 transition-all">üëÅÔ∏è View Template</button>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">üìÅ Year 1 (e.g., 2024)</h2>
                    <label class="flex flex-col items-center justify-center w-full h-32 border-2 border-dashed border-blue-300 rounded-lg cursor-pointer bg-blue-50 hover:bg-blue-100 transition-all">
                        <div class="flex flex-col items-center justify-center pt-5 pb-6">
                            <svg class="w-10 h-10 mb-3 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                            </svg>
                            <p class="mb-2 text-sm text-gray-700"><span class="font-semibold">Click to upload</span> Year 1 CSV</p>
                        </div>
                        <input type="file" class="hidden" accept=".csv" onchange="handleComparisonUpload(event, 'year1')">
                    </label>
                    <div id="status-year1" class="mt-4 text-gray-600"></div>
                </div>

                <div class="bg-white rounded-xl shadow-lg p-6">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">üìÅ Year 2 (e.g., 2025)</h2>
                    <label class="flex flex-col items-center justify-center w-full h-32 border-2 border-dashed border-green-300 rounded-lg cursor-pointer bg-green-50 hover:bg-green-100 transition-all">
                        <div class="flex flex-col items-center justify-center pt-5 pb-6">
                            <svg class="w-10 h-10 mb-3 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                            </svg>
                            <p class="mb-2 text-sm text-gray-700"><span class="font-semibold">Click to upload</span> Year 2 CSV</p>
                        </div>
                        <input type="file" class="hidden" accept=".csv" onchange="handleComparisonUpload(event, 'year2')">
                    </label>
                    <div id="status-year2" class="mt-4 text-gray-600"></div>
                </div>
            </div>

            <div id="comparisonResults" style="display:none;">
                <div class="grid grid-cols-1 md:grid-cols-5 gap-4 mb-6">
                    <div class="card bg-gradient-to-br from-blue-500 to-blue-600 rounded-xl p-6 text-white shadow-lg">
                        <p class="text-blue-100 text-sm font-medium">Total Revenue</p>
                        <div class="flex items-end justify-between mt-2">
                            <div>
                                <p id="compRevY1" class="text-lg font-bold">‡∏ø0M</p>
                                <p id="compRevY2" class="text-2xl font-bold">‡∏ø0M</p>
                            </div>
                            <p id="compRevChange" class="text-xl font-bold">0%</p>
                        </div>
                    </div>
                    <div class="card bg-gradient-to-br from-green-500 to-green-600 rounded-xl p-6 text-white shadow-lg">
                        <p class="text-green-100 text-sm font-medium">Total Quantity</p>
                        <div class="flex items-end justify-between mt-2">
                            <div>
                                <p id="compQtyY1" class="text-lg font-bold">0</p>
                                <p id="compQtyY2" class="text-2xl font-bold">0</p>
                            </div>
                            <p id="compQtyChange" class="text-xl font-bold">0%</p>
                        </div>
                    </div>
                    <div class="card bg-gradient-to-br from-purple-500 to-purple-600 rounded-xl p-6 text-white shadow-lg">
                        <p class="text-purple-100 text-sm font-medium">Total Orders</p>
                        <div class="flex items-end justify-between mt-2">
                            <div>
                                <p id="compOrdersY1" class="text-lg font-bold">0</p>
                                <p id="compOrdersY2" class="text-2xl font-bold">0</p>
                            </div>
                            <p id="compOrdersChange" class="text-xl font-bold">0%</p>
                        </div>
                    </div>
                    <div class="card bg-gradient-to-br from-orange-500 to-orange-600 rounded-xl p-6 text-white shadow-lg">
                        <p class="text-orange-100 text-sm font-medium">Avg Annual Sales</p>
                        <div class="flex items-end justify-between mt-2">
                            <div>
                                <p id="compAvgY1" class="text-lg font-bold">‡∏ø0</p>
                                <p id="compAvgY2" class="text-2xl font-bold">‡∏ø0</p>
                            </div>
                            <p id="compAvgChange" class="text-xl font-bold">0%</p>
                        </div>
                    </div>
                    <div class="card bg-gradient-to-br from-pink-500 to-pink-600 rounded-xl p-6 text-white shadow-lg">
                        <p class="text-pink-100 text-sm font-medium">Avg Profit Margin</p>
                        <div class="flex items-end justify-between mt-2">
                            <div>
                                <p id="compMarginY1" class="text-lg font-bold">0%</p>
                                <p id="compMarginY2" class="text-2xl font-bold">0%</p>
                            </div>
                            <p id="compMarginChange" class="text-xl font-bold">0%</p>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
                    <div class="dropdown">
                        <button class="px-6 py-3 bg-teal-500 text-white rounded-lg hover:bg-teal-600 transition-all flex items-center gap-2 shadow-lg">
                            üìä Export Comparison ‚ñº
                        </button>
                        <div class="dropdown-content">
                            <a onclick="exportComparison('csv')" href="javascript:void(0)">
                                <span>üìÑ</span> Export as CSV
                            </a>
                            <a onclick="exportComparison('excel')" href="javascript:void(0)">
                                <span>üìó</span> Export as Excel
                            </a>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-xl shadow-lg p-6">
                    <h3 class="text-2xl font-bold text-gray-800 mb-6">üìä Detailed Comparison</h3>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm">
                            <thead>
                                <tr class="border-b-2 border-gray-200">
                                    <th class="text-left py-3 px-2 font-semibold text-gray-700">Market Type</th>
                                    <th class="text-left py-3 px-2 font-semibold text-gray-700">Customer Name</th>
                                    <th class="text-left py-3 px-2 font-semibold text-gray-700">Product Description</th>
                                    <th class="text-left py-3 px-2 font-semibold text-gray-700">Industry</th>
                                    <th class="text-left py-3 px-2 font-semibold text-gray-700">Country</th>
                                    <th class="text-left py-3 px-2 font-semibold text-gray-700">Product type</th>
                                    <th class="text-left py-3 px-2 font-semibold text-gray-700">Sales</th>
                                    <th class="text-right py-3 px-2 font-semibold text-gray-700">Selling Price</th>
                                    <th class="text-right py-3 px-2 font-semibold text-gray-700">Standard price</th>
                                    <th class="text-right py-3 px-2 font-semibold text-gray-700">Total Annual Qty (Y1)</th>
                                    <th class="text-right py-3 px-2 font-semibold text-gray-700">Total Annual Qty (Y2)</th>
                                    <th class="text-right py-3 px-2 font-semibold text-gray-700">Total Annual Sales (Y1)</th>
                                    <th class="text-right py-3 px-2 font-semibold text-gray-700">Total Annual Sales (Y2)</th>
                                    <th class="text-right py-3 px-2 font-semibold text-gray-700">Gross profit% (Y1)</th>
                                    <th class="text-right py-3 px-2 font-semibold text-gray-700">Gross profit% (Y2)</th>
                                </tr>
                            </thead>
                            <tbody id="comparisonTableBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div id="content-data" class="bg-white rounded-xl shadow-lg p-6" style="display:none;">
            <div class="flex justify-between items-center mb-6 flex-wrap gap-3">
                <h2 class="text-2xl font-bold text-gray-800">Sales Data</h2>
                <div class="flex gap-2 flex-wrap">
                    <button onclick="downloadTemplate('sales')" class="px-4 py-2 bg-purple-500 text-white rounded-lg hover:bg-purple-600 transition-all">üì• Download Template</button>
                    <button onclick="showTemplatePreview('sales')" class="px-4 py-2 bg-orange-500 text-white rounded-lg hover:bg-orange-600 transition-all">üëÅÔ∏è View Template</button>
                    <label class="px-4 py-2 bg-green-500 text-white rounded-lg cursor-pointer hover:bg-green-600 transition-all">
                        ‚¨ÜÔ∏è Import CSV
                        <input type="file" accept=".csv" onchange="handleFileUpload(event, 'sales')" class="hidden" />
                    </label>
                    <button onclick="exportData('sales')" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-all">‚¨áÔ∏è Export CSV</button>
                </div>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full" id="salesTable">
                    <thead>
                        <tr class="border-b-2 border-gray-200">
                            <th class="text-left py-3 px-4 font-semibold text-gray-700">Month</th>
                            <th class="text-left py-3 px-4 font-semibold text-gray-700">Customer</th>
                            <th class="text-left py-3 px-4 font-semibold text-gray-700">Market</th>
                            <th class="text-left py-3 px-4 font-semibold text-gray-700">Description</th>
                            <th class="text-left py-3 px-4 font-semibold text-gray-700">Type</th>
                            <th class="text-right py-3 px-4 font-semibold text-gray-700">Qty</th>
                            <th class="text-right py-3 px-4 font-semibold text-gray-700">Price</th>
                            <th class="text-right py-3 px-4 font-semibold text-gray-700">Total</th>
                            <th class="text-left py-3 px-4 font-semibold text-gray-700">Sales</th>
                        </tr>
                    </thead>
                    <tbody id="salesTableBody"></tbody>
                </table>
            </div>
        </div>

        <div id="content-prices" class="bg-white rounded-xl shadow-lg p-6" style="display:none;">
            <div class="flex justify-between items-center mb-6 flex-wrap gap-3">
                <h2 class="text-2xl font-bold text-gray-800">Standard Prices</h2>
                <div class="flex gap-2 flex-wrap">
                    <button onclick="downloadTemplate('prices')" class="px-4 py-2 bg-purple-500 text-white rounded-lg hover:bg-purple-600 transition-all">üì• Download Template</button>
                    <button onclick="showTemplatePreview('prices')" class="px-4 py-2 bg-orange-500 text-white rounded-lg hover:bg-orange-600 transition-all">üëÅÔ∏è View Template</button>
                    <label class="px-4 py-2 bg-green-500 text-white rounded-lg cursor-pointer hover:bg-green-600 transition-all">
                        ‚¨ÜÔ∏è Import CSV
                        <input type="file" accept=".csv" onchange="handleFileUpload(event, 'prices')" class="hidden" />
                    </label>
                    <button onclick="exportData('prices')" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-all">‚¨áÔ∏è Export CSV</button>
                </div>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead>
                        <tr class="border-b-2 border-gray-200">
                            <th class="text-left py-3 px-4 font-semibold text-gray-700">Product</th>
                            <th class="text-right py-3 px-4 font-semibold text-gray-700">Standard Price</th>
                        </tr>
                    </thead>
                    <tbody id="pricesTableBody"></tbody>
                </table>
            </div>
        </div>

        <div id="content-customers" class="bg-white rounded-xl shadow-lg p-6" style="display:none;">
            <div class="flex justify-between items-center mb-6 flex-wrap gap-3">
                <h2 class="text-2xl font-bold text-gray-800">Customer Details</h2>
                <div class="flex gap-2 flex-wrap">
                    <button onclick="downloadTemplate('customers')" class="px-4 py-2 bg-purple-500 text-white rounded-lg hover:bg-purple-600 transition-all">üì• Download Template</button>
                    <button onclick="showTemplatePreview('customers')" class="px-4 py-2 bg-orange-500 text-white rounded-lg hover:bg-orange-600 transition-all">üëÅÔ∏è View Template</button>
                    <label class="px-4 py-2 bg-green-500 text-white rounded-lg cursor-pointer hover:bg-green-600 transition-all">
                        ‚¨ÜÔ∏è Import CSV
                        <input type="file" accept=".csv" onchange="handleFileUpload(event, 'customers')" class="hidden" />
                    </label>
                    <button onclick="exportData('customers')" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-all">‚¨áÔ∏è Export CSV</button>
                </div>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead>
                        <tr class="border-b-2 border-gray-200">
                            <th class="text-left py-3 px-4 font-semibold text-gray-700">Customer Name</th>
                            <th class="text-left py-3 px-4 font-semibold text-gray-700">Country</th>
                        </tr>
                    </thead>
                    <tbody id="customersTableBody"></tbody>
                </table>
            </div>
        </div>

        <div id="content-industry" class="bg-white rounded-xl shadow-lg p-6" style="display:none;">
            <div class="flex justify-between items-center mb-6 flex-wrap gap-3">
                <h2 class="text-2xl font-bold text-gray-800">Product Industry</h2>
                <div class="flex gap-2 flex-wrap">
                    <button onclick="downloadTemplate('industry')" class="px-4 py-2 bg-purple-500 text-white rounded-lg hover:bg-purple-600 transition-all">üì• Download Template</button>
                    <button onclick="showTemplatePreview('industry')" class="px-4 py-2 bg-orange-500 text-white rounded-lg hover:bg-orange-600 transition-all">üëÅÔ∏è View Template</button>
                    <label class="px-4 py-2 bg-green-500 text-white rounded-lg cursor-pointer hover:bg-green-600 transition-all">
                        ‚¨ÜÔ∏è Import CSV
                        <input type="file" accept=".csv" onchange="handleFileUpload(event, 'industry')" class="hidden" />
                    </label>
                    <button onclick="exportData('industry')" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-all">‚¨áÔ∏è Export CSV</button>
                </div>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead>
                        <tr class="border-b-2 border-gray-200">
                            <th class="text-left py-3 px-4 font-semibold text-gray-700">Product Name</th>
                            <th class="text-left py-3 px-4 font-semibold text-gray-700">Industry</th>
                        </tr>
                    </thead>
                    <tbody id="industryTableBody"></tbody>
                </table>
            </div>
        </div>

        <div id="content-profit" class="space-y-6" style="display:none;">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="card bg-gradient-to-br from-green-500 to-green-600 rounded-xl p-6 text-white shadow-lg">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-green-100 text-sm font-medium">Total Revenue</p>
                            <p id="profitTotalRevenue" class="text-3xl font-bold mt-2">‡∏ø0</p>
                        </div>
                        <svg class="w-12 h-12 text-green-200" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                    </div>
                </div>
                <div class="card bg-gradient-to-br from-orange-500 to-orange-600 rounded-xl p-6 text-white shadow-lg">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-orange-100 text-sm font-medium">Total Cost</p>
                            <p id="profitTotalCost" class="text-3xl font-bold mt-2">‡∏ø0</p>
                        </div>
                        <svg class="w-12 h-12 text-orange-200" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 8h6m-5 0a3 3 0 110 6H9l3 3m-3-6h6m6 1a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                    </div>
                </div>
                <div class="card bg-gradient-to-br from-blue-500 to-blue-600 rounded-xl p-6 text-white shadow-lg">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-blue-100 text-sm font-medium">Gross Profit</p>
                            <p id="profitGrossProfit" class="text-3xl font-bold mt-2">‡∏ø0</p>
                        </div>
                        <svg class="w-12 h-12 text-blue-200" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path>
                        </svg>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-xl shadow-lg p-6">
                <h3 class="text-xl font-bold text-gray-800 mb-4">üìä Profit Margin Analysis</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="flex items-center justify-between p-4 bg-blue-50 rounded-lg">
                        <div>
                            <p class="text-sm font-semibold text-gray-700">Gross Profit Margin</p>
                            <p id="profitMargin" class="text-3xl font-bold text-blue-600 mt-2">0%</p>
                        </div>
                    </div>
                    <div class="p-4 bg-gray-50 rounded-lg">
                        <p class="text-sm font-semibold text-gray-700 mb-3">Profit Breakdown</p>
                        <div class="space-y-2">
                            <div class="flex justify-between items-center">
                                <span class="text-sm text-gray-600">Average Profit per Order</span>
                                <span id="avgProfitPerOrder" class="text-sm font-bold text-gray-800">‡∏ø0</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-sm text-gray-600">Total Orders</span>
                                <span id="profitTotalOrders" class="text-sm font-bold text-gray-800">0</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-bold text-gray-800">üìà Monthly Profit Trend</h3>
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="checkbox" id="showMonthlyValues" onchange="toggleChartLabels('monthlyProfitChart')" checked class="w-5 h-5 text-blue-600 rounded focus:ring-2 focus:ring-blue-500">
                            <span class="text-sm font-medium text-gray-700">Show Values</span>
                        </label>
                    </div>
                    <div style="position: relative; height: 300px;">
                        <canvas id="monthlyProfitChart"></canvas>
                    </div>
                </div>

                <div class="bg-white rounded-xl shadow-lg p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-bold text-gray-800">üèÜ Top 10 Profitable Products</h3>
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="checkbox" id="showTopProductValues" onchange="toggleChartLabels('topProductsChart')" checked class="w-5 h-5 text-blue-600 rounded focus:ring-2 focus:ring-blue-500">
                            <span class="text-sm font-medium text-gray-700">Show Values</span>
                        </label>
                    </div>
                    <div style="position: relative; height: 300px;">
                        <canvas id="topProductsChart"></canvas>
                    </div>
                </div>

                <div class="bg-white rounded-xl shadow-lg p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-bold text-gray-800">üí∞ Profit (THB) by Product Type</h3>
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="checkbox" id="showProfitTypeValues" onchange="toggleChartLabels('profitTypeChart')" checked class="w-5 h-5 text-blue-600 rounded focus:ring-2 focus:ring-blue-500">
                            <span class="text-sm font-medium text-gray-700">Show Values</span>
                        </label>
                    </div>
                    <div style="position: relative; height: 300px;">
                        <canvas id="profitTypeChart"></canvas>
                    </div>
                </div>

                <div class="bg-white rounded-xl shadow-lg p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-bold text-gray-800">üéØ Profit % by Product Type</h3>
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="checkbox" id="showMarginTypeValues" onchange="toggleChartLabels('marginTypeChart')" checked class="w-5 h-5 text-blue-600 rounded focus:ring-2 focus:ring-blue-500">
                            <span class="text-sm font-medium text-gray-700">Show Values</span>
                        </label>
                    </div>
                    <div style="position: relative; height: 300px;">
                        <canvas id="marginTypeChart"></canvas>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-xl shadow-lg p-6">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-xl font-bold text-gray-800">üí∞ Profit Details by Transaction</h3>
                    <label class="flex items-center gap-2 cursor-pointer">
                        <input type="checkbox" id="showProfitDetails" onchange="toggleProfitDetails()" class="w-5 h-5 text-blue-600 rounded focus:ring-2 focus:ring-blue-500">
                        <span class="text-sm font-medium text-gray-700">Show Details</span>
                    </label>
                </div>
                <div id="profitDetailsTable" style="display:none;">
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead>
                                <tr class="border-b-2 border-gray-200">
                                    <th class="text-left py-3 px-4 font-semibold text-gray-700">Month</th>
                                    <th class="text-left py-3 px-4 font-semibold text-gray-700">Customer</th>
                                    <th class="text-left py-3 px-4 font-semibold text-gray-700">Description</th>
                                    <th class="text-right py-3 px-4 font-semibold text-gray-700">Qty</th>
                                    <th class="text-right py-3 px-4 font-semibold text-gray-700">Total Revenue</th>
                                    <th class="text-right py-3 px-4 font-semibold text-gray-700">Total Cost</th>
                                    <th class="text-right py-3 px-4 font-semibold text-gray-700">Gross Profit</th>
                                    <th class="text-right py-3 px-4 font-semibold text-gray-700">Margin %</th>
                                </tr>
                            </thead>
                            <tbody id="profitTableBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="templateModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50" onclick="closeModal(event)">
        <div class="bg-white rounded-xl shadow-2xl max-w-6xl w-full mx-4 max-h-[90vh] overflow-hidden" onclick="event.stopPropagation()">
            <div class="bg-gradient-to-r from-blue-500 to-blue-600 text-white p-6 flex justify-between items-center">
                <h3 id="modalTitle" class="text-2xl font-bold">Template Preview</h3>
                <button onclick="closeTemplatePreview()" class="text-white hover:text-gray-200 text-3xl font-bold leading-none">√ó</button>
            </div>
            <div class="p-6 overflow-auto max-h-[calc(90vh-120px)]">
                <div id="modalContent" class="space-y-4"></div>
            </div>
            <div class="bg-gray-50 px-6 py-4 flex justify-end gap-3 border-t">
                <button onclick="closeTemplatePreview()" class="px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 transition-all">Close</button>
                <button id="modalDownloadBtn" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-all">üì• Download Template</button>
            </div>
        </div>
    </div>

    <script>
        // Register ChartDataLabels
        if (typeof Chart !== 'undefined' && typeof ChartDataLabels !== 'undefined') {
            Chart.register(ChartDataLabels);
            Chart.defaults.set('plugins.datalabels', { display: false });
        }

        // Data storage
        let salesData = [
            { month: 'Jan', customer: '‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó ‡∏£‡∏∞‡∏¢‡∏≠‡∏á MDF', market: 'Domestic', description: 'KERNIK KLD-101 (1,000KG)', type: 'Release Agent', qty: 1000, price: 78, total: 78000, sales: 'Chuthamas.S' },
            { month: 'Jan', customer: '‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó ‡πÄ‡∏°‡πÇ‡∏ó‡∏£ MDF', market: 'Domestic', description: 'KERNIK KLD-101 (1,000KG)', type: 'Release Agent', qty: 2000, price: 78, total: 156000, sales: 'Chuthamas.S' },
            { month: 'Feb', customer: 'Goodyear (Thailand)', market: 'Domestic', description: 'RimLube 928/45 (200KG)', type: 'Release Agent', qty: 9, price: 11026, total: 99234, sales: 'Natchaphon.K' }
        ];
        let standardPrices = [
            { product: 'KERNIK ANTI-051/2 (1000kg)', standardPrice: 43 },
            { product: 'KERNIK KLD-GREEN-01 (1000kg)', standardPrice: 50.8 },
            { product: 'KERNIK KLD-101 (1,000KG)', standardPrice: 38 }
        ];
        let customers = [
            { name: '‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó ‡∏ß‡∏ô‡∏ä‡∏±‡∏¢ ‡∏û‡∏≤‡πÄ‡∏ô‡∏•‡∏≠‡∏¥‡∏ô‡∏î‡∏±‡∏™‡∏ó‡∏£‡∏µ‡∏™‡πå‡∏à‡∏≥‡∏Å‡∏±‡∏î', country: 'Thailand' },
            { name: '‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó ‡∏û‡∏≤‡πÄ‡∏ô‡∏• ‡∏û‡∏•‡∏±‡∏™ MDF ‡∏à‡∏≥‡∏Å‡∏±‡∏î', country: 'Thailand' },
            { name: 'ACME INTER (VIETNAM) COMPANY LIMITED', country: 'Vietnam' }
        ];
        let industry = [
            { product: 'KERNIK ANTI-051/2 (1000kg)', industry: 'Wood' },
            { product: 'KERNIK KLD-GREEN-01 (1000kg)', industry: 'Wood' },
            { product: 'KERNIK KLO-022/11-H (18L)', industry: 'Rubber part' },
            { product: 'RimLube 928/45 (200KG)', industry: 'Rubber tire' }
        ];

        let comparisonData = { year1: null, year2: null };
        let chartInstances = {};
        let filteredData = [...salesData];
        let profitData = [];
        let currentTemplateType = '';

        // --- NEW: Firebase Sync Logic ---
        window.updateLocalDataFromCloud = function(data) {
            if (data) {
                // Update local variables with data from Cloud
                if(data.salesData) salesData = data.salesData;
                if(data.standardPrices) standardPrices = data.standardPrices;
                if(data.customers) customers = data.customers;
                if(data.industry) industry = data.industry;
                
                // Refresh UI
                filteredData = [...salesData];
                calculateProfitData();
                populateFilterOptions();
                updateStats();
                renderSalesTable();
                renderPricesTable();
                renderCustomersTable();
                renderIndustryTable();
                
                // Wait for chart rendering (prevent errors)
                setTimeout(() => {
                    renderDashboardCharts();
                    showNotification('‚òÅÔ∏è Sync complete', 'success');
                }, 500);
            }
        };
        // --------------------------------

        function showNotification(message, type) {
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 px-6 py-3 rounded-lg shadow-lg text-white font-semibold z-50 transition-all ${
                type === 'success' ? 'bg-green-500' : 'bg-red-500'
            }`;
            notification.textContent = message;
            notification.style.animation = 'slideIn 0.3s ease-out';
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease-in';
                setTimeout(() => notification.remove(), 300);
            }, 2000);
        }

        function showTab(tab) {
            ['dashboard', 'comparison', 'data', 'prices', 'customers', 'industry', 'profit'].forEach(t => {
                const content = document.getElementById(`content-${t}`);
                if (content) {
                    content.style.display = t === tab ? (t === 'dashboard' || t === 'profit' ? 'block' : 'block') : 'none';
                }
                const btn = document.getElementById(`tab-${t}`);
                if (btn) {
                    if (t === tab) {
                        btn.className = 'tab-button px-6 py-3 rounded-lg font-medium bg-blue-500 text-white';
                    } else {
                        btn.className = 'tab-button px-6 py-3 rounded-lg font-medium text-gray-700 hover:bg-gray-100';
                    }
                }
            });
            
            if (tab === 'dashboard') {
                populateFilterOptions();
                updateStats();
                renderSalesTable();
                setTimeout(() => {
                    renderDashboardCharts();
                }, 100);
            } else if (tab === 'data') {
                renderSalesTable();
            } else if (tab === 'prices') {
                renderPricesTable();
            } else if (tab === 'customers') {
                renderCustomersTable();
            } else if (tab === 'industry') {
                renderIndustryTable();
            } else if (tab === 'profit') {
                setTimeout(() => {
                    calculateProfitData();
                    updateProfitAnalysis();
                }, 100);
            }
        }

        function toggleDashboardChart(chartType) {
            const chartDiv = document.getElementById(`chart-${chartType}`);
            const checkbox = document.getElementById(`chart${chartType.charAt(0).toUpperCase() + chartType.slice(1)}`);
            
            if (checkbox.checked) {
                chartDiv.style.display = 'block';
                setTimeout(() => renderDashboardCharts(), 100);
            } else {
                chartDiv.style.display = 'none';
            }
        }

        function toggleDashboardChartLabels(chartId) {
            if (chartInstances[chartId]) {
                const chart = chartInstances[chartId];
                const checkbox = document.getElementById(
                    chartId === 'dashMonthlyRevenueChart' ? 'showDashMonthlyValues' :
                    chartId === 'dashProductTypeChart' ? 'showProductTypeValues' :
                    chartId === 'dashTopCustomersChart' ? 'showTopCustomersValues' :
                    chartId === 'dashSalesTeamChart' ? 'showSalesTeamValues' :
                    'showTopProductsValues'
                );
                
                if (checkbox) {
                    chart.options.plugins.datalabels.display = checkbox.checked;
                    chart.update();
                }
            }
        }

        function renderDashboardCharts() {
            renderDashMonthlyRevenueChart();
            if (document.getElementById('chartProductType').checked) renderDashProductTypeChart();
            if (document.getElementById('chartMarketBreakdown').checked) renderDashMarketChart();
            if (document.getElementById('chartTopCustomers').checked) renderDashTopCustomersChart();
            if (document.getElementById('chartSalesTeam').checked) renderDashSalesTeamChart();
            if (document.getElementById('chartTopProducts').checked) renderDashTopProductsChart();
        }

        function renderDashMonthlyRevenueChart() {
            const ctx = document.getElementById('dashMonthlyRevenueChart');
            if (!ctx) return;

            const monthlyData = {};
            filteredData.forEach(item => {
                if (!monthlyData[item.month]) {
                    monthlyData[item.month] = 0;
                }
                monthlyData[item.month] += item.total;
            });

            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            const labels = months.filter(m => monthlyData[m]);
            const data = labels.map(m => monthlyData[m]);

            if (chartInstances['dashMonthlyRevenueChart']) {
                chartInstances['dashMonthlyRevenueChart'].destroy();
            }

            try {
                chartInstances['dashMonthlyRevenueChart'] = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Revenue',
                            data: data,
                            backgroundColor: 'rgba(59, 130, 246, 0.8)',
                            borderColor: 'rgb(59, 130, 246)',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: true, position: 'top' },
                            datalabels: {
                                display: true,
                                color: '#1f2937',
                                font: { weight: 'bold', size: 11 },
                                anchor: 'end',
                                align: 'end',
                                formatter: (value) => value >= 1000000 ? '‡∏ø' + (value/1000000).toFixed(1) + 'M' : '‡∏ø' + (value/1000).toFixed(1) + 'K'
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: (value) => '‡∏ø' + (value/1000000).toFixed(1) + 'M'
                                }
                            }
                        }
                    }
                });
            } catch (error) {
                console.error('Error creating dashboard monthly revenue chart:', error);
            }
        }

        function renderDashProductTypeChart() {
            const ctx = document.getElementById('dashProductTypeChart');
            if (!ctx) return;

            const typeData = {};
            filteredData.forEach(item => {
                if (!typeData[item.type]) typeData[item.type] = 0;
                typeData[item.type] += item.total;
            });

            const sortedTypes = Object.entries(typeData).sort((a, b) => b[1] - a[1]);
            const labels = sortedTypes.map(t => t[0]);
            const data = sortedTypes.map(t => t[1]);

            if (chartInstances['dashProductTypeChart']) {
                chartInstances['dashProductTypeChart'].destroy();
            }

            try {
                chartInstances['dashProductTypeChart'] = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Sales',
                            data: data,
                            backgroundColor: 'rgba(168, 85, 247, 0.8)',
                            borderColor: 'rgb(168, 85, 247)',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false },
                            datalabels: {
                                display: true,
                                color: '#1f2937',
                                font: { weight: 'bold', size: 10 },
                                anchor: 'end',
                                align: 'end',
                                formatter: (value) => '‡∏ø' + (value/1000000).toFixed(1) + 'M'
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: (value) => '‡∏ø' + (value/1000000).toFixed(1) + 'M'
                                }
                            }
                        }
                    }
                });
            } catch (error) {
                console.error('Error creating product type chart:', error);
            }
        }

        function renderDashMarketChart() {
            const ctx = document.getElementById('dashMarketChart');
            if (!ctx) return;

            const marketData = { Domestic: 0, Export: 0 };
            filteredData.forEach(item => {
                if (marketData[item.market] !== undefined) {
                    marketData[item.market] += item.total;
                }
            });

            if (chartInstances['dashMarketChart']) {
                chartInstances['dashMarketChart'].destroy();
            }

            try {
                chartInstances['dashMarketChart'] = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Domestic', 'Export'],
                        datasets: [{
                            data: [marketData.Domestic, marketData.Export],
                            backgroundColor: ['rgba(34, 197, 94, 0.8)', 'rgba(59, 130, 246, 0.8)'],
                            borderColor: ['rgb(34, 197, 94)', 'rgb(59, 130, 246)'],
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: true, position: 'bottom' },
                            datalabels: {
                                display: true,
                                color: '#ffffff',
                                font: { weight: 'bold', size: 14 },
                                formatter: (value, ctx) => {
                                    const total = ctx.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = ((value / total) * 100).toFixed(1);
                                    return percentage + '%';
                                }
                            }
                        }
                    }
                });
            } catch (error) {
                console.error('Error creating market chart:', error);
            }
        }

        function renderDashTopCustomersChart() {
            const ctx = document.getElementById('dashTopCustomersChart');
            if (!ctx) return;

            const customerData = {};
            filteredData.forEach(item => {
                if (!customerData[item.customer]) customerData[item.customer] = 0;
                customerData[item.customer] += item.total;
            });

            const sortedCustomers = Object.entries(customerData)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 10);

            const labels = sortedCustomers.map(c => c[0].substring(0, 30));
            const data = sortedCustomers.map(c => c[1]);

            if (chartInstances['dashTopCustomersChart']) {
                chartInstances['dashTopCustomersChart'].destroy();
            }

            try {
                chartInstances['dashTopCustomersChart'] = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Revenue',
                            data: data,
                            backgroundColor: 'rgba(251, 146, 60, 0.8)',
                            borderColor: 'rgb(251, 146, 60)',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        indexAxis: 'y',
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false },
                            datalabels: {
                                display: true,
                                color: '#1f2937',
                                font: { weight: 'bold', size: 10 },
                                anchor: 'end',
                                align: 'end',
                                formatter: (value) => '‡∏ø' + (value/1000000).toFixed(1) + 'M'
                            }
                        },
                        scales: {
                            x: {
                                beginAtZero: true,
                                ticks: {
                                    callback: (value) => '‡∏ø' + (value/1000000).toFixed(0) + 'M'
                                }
                            }
                        }
                    }
                });
            } catch (error) {
                console.error('Error creating top customers chart:', error);
            }
        }

        function renderDashSalesTeamChart() {
            const ctx = document.getElementById('dashSalesTeamChart');
            if (!ctx) return;

            const salesData = {};
            filteredData.forEach(item => {
                if (!salesData[item.sales]) salesData[item.sales] = 0;
                salesData[item.sales] += item.total;
            });

            const sortedSales = Object.entries(salesData).sort((a, b) => b[1] - a[1]);
            const labels = sortedSales.map(s => s[0]);
            const data = sortedSales.map(s => s[1]);

            if (chartInstances['dashSalesTeamChart']) {
                chartInstances['dashSalesTeamChart'].destroy();
            }

            try {
                chartInstances['dashSalesTeamChart'] = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Revenue',
                            data: data,
                            backgroundColor: 'rgba(236, 72, 153, 0.8)',
                            borderColor: 'rgb(236, 72, 153)',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false },
                            datalabels: {
                                display: true,
                                color: '#1f2937',
                                font: { weight: 'bold', size: 10 },
                                anchor: 'end',
                                align: 'end',
                                formatter: (value) => '‡∏ø' + (value/1000000).toFixed(1) + 'M'
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: (value) => '‡∏ø' + (value/1000000).toFixed(1) + 'M'
                                }
                            }
                        }
                    }
                });
            } catch (error) {
                console.error('Error creating sales team chart:', error);
            }
        }

        function renderDashTopProductsChart() {
            const ctx = document.getElementById('dashTopProductsChart');
            if (!ctx) return;

            const productData = {};
            filteredData.forEach(item => {
                if (!productData[item.description]) productData[item.description] = 0;
                productData[item.description] += item.total;
            });

            const sortedProducts = Object.entries(productData)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 10);

            const labels = sortedProducts.map(p => p[0].substring(0, 30));
            const data = sortedProducts.map(p => p[1]);

            if (chartInstances['dashTopProductsChart']) {
                chartInstances['dashTopProductsChart'].destroy();
            }

            try {
                chartInstances['dashTopProductsChart'] = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Revenue',
                            data: data,
                            backgroundColor: 'rgba(14, 165, 233, 0.8)',
                            borderColor: 'rgb(14, 165, 233)',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        indexAxis: 'y',
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false },
                            datalabels: {
                                display: true,
                                color: '#1f2937',
                                font: { weight: 'bold', size: 10 },
                                anchor: 'end',
                                align: 'end',
                                formatter: (value) => '‡∏ø' + (value/1000000).toFixed(1) + 'M'
                            }
                        },
                        scales: {
                            x: {
                                beginAtZero: true,
                                ticks: {
                                    callback: (value) => '‡∏ø' + (value/1000000).toFixed(0) + 'M'
                                }
                            }
                        }
                    }
                });
            } catch (error) {
                console.error('Error creating top products chart:', error);
            }
        }

        function parseCSV(text) {
            const rows = [];
            let currentRow = [];
            let currentField = '';
            let insideQuotes = false;
            
            for (let i = 0; i < text.length; i++) {
                const char = text[i];
                const nextChar = text[i + 1];
                
                if (char === '"') {
                    if (insideQuotes && nextChar === '"') {
                        currentField += '"';
                        i++;
                    } else {
                        insideQuotes = !insideQuotes;
                    }
                } else if (char === ',' && !insideQuotes) {
                    currentRow.push(currentField.trim());
                    currentField = '';
                } else if ((char === '\n' || char === '\r') && !insideQuotes) {
                    if (char === '\r' && nextChar === '\n') i++;
                    if (currentField || currentRow.length > 0) {
                        currentRow.push(currentField.trim());
                        if (currentRow.some(cell => cell.length > 0)) {
                            rows.push(currentRow);
                        }
                        currentRow = [];
                        currentField = '';
                    }
                } else {
                    currentField += char;
                }
            }
            
            if (currentField || currentRow.length > 0) {
                currentRow.push(currentField.trim());
                if (currentRow.some(cell => cell.length > 0)) {
                    rows.push(currentRow);
                }
            }
            
            return rows;
        }

        function getProductIndustry(description) {
            const productName = description.split('(')[0].trim();
            const industryMatch = industry.find(item => {
                const cleanDescription = productName.toLowerCase();
                const cleanIndustryProduct = item.product.trim().toLowerCase();
                return cleanDescription === cleanIndustryProduct || cleanIndustryProduct.includes(cleanDescription);
            });
            return industryMatch ? industryMatch.industry : 'Unknown';
        }

        function calculateProfitData() {
            profitData = salesData.map(sale => {
                // Extract product name with size - ‡∏£‡∏±‡∏Å‡∏©‡∏≤‡∏Ç‡∏ô‡∏≤‡∏î‡πÑ‡∏ß‡πâ‡∏î‡πâ‡∏ß‡∏¢
                const productName = sale.description.trim();
                
                // ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ standard price ‡πÇ‡∏î‡∏¢‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏£‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏£‡∏ß‡∏°‡∏Ç‡∏ô‡∏≤‡∏î
                let priceMatch = standardPrices.find(p => {
                    const cleanSaleProduct = productName.toLowerCase().replace(/\s+/g, ' ');
                    const cleanPriceProduct = p.product.trim().toLowerCase().replace(/\s+/g, ' ');
                    
                    // ‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (exact match) ‡∏´‡∏£‡∏∑‡∏≠ ‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏•‡∏∞‡∏Ç‡∏ô‡∏≤‡∏î‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô
                    return cleanSaleProduct === cleanPriceProduct;
                });

                const standardPrice = priceMatch ? priceMatch.standardPrice : 0;
                const totalCost = standardPrice * sale.qty;
                const grossProfit = sale.total - totalCost;
                
                // ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡∏ñ‡πâ‡∏≤ totalCost = 0 (‡πÑ‡∏°‡πà‡∏°‡∏µ standard price) ‡πÉ‡∏´‡πâ margin = 0 ‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏∞‡πÄ‡∏õ‡πá‡∏ô 100%
                let profitMargin = 0;
                if (sale.total > 0 && totalCost > 0) {
                    profitMargin = (grossProfit / sale.total) * 100;
                } else if (sale.total > 0 && totalCost === 0) {
                    // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ standard price ‡πÉ‡∏´‡πâ margin = 0 ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏±‡∏ö‡∏™‡∏ô
                    profitMargin = 0;
                }

                return {
                    ...sale,
                    productName,
                    standardPrice,
                    totalCost,
                    grossProfit,
                    profitMargin,
                    priceFound: !!priceMatch
                };
            });
        }

        function updateProfitAnalysis() {
            const totalRevenue = profitData.reduce((sum, item) => sum + item.total, 0);
            const totalCost = profitData.reduce((sum, item) => sum + item.totalCost, 0);
            const grossProfit = profitData.reduce((sum, item) => sum + item.grossProfit, 0);
            const profitMargin = totalRevenue > 0 ? (grossProfit / totalRevenue) * 100 : 0;
            const avgProfitPerOrder = profitData.length > 0 ? grossProfit / profitData.length : 0;

            document.getElementById('profitTotalRevenue').textContent = `‡∏ø${totalRevenue.toLocaleString(undefined, {maximumFractionDigits: 0})}`;
            document.getElementById('profitTotalCost').textContent = `‡∏ø${totalCost.toLocaleString(undefined, {maximumFractionDigits: 0})}`;
            document.getElementById('profitGrossProfit').textContent = `‡∏ø${grossProfit.toLocaleString(undefined, {maximumFractionDigits: 0})}`;
            document.getElementById('profitMargin').textContent = `${profitMargin.toFixed(2)}%`;
            document.getElementById('avgProfitPerOrder').textContent = `‡∏ø${Math.round(avgProfitPerOrder).toLocaleString()}`;
            document.getElementById('profitTotalOrders').textContent = profitData.length;

            renderProfitTable();
            renderProfitCharts();
        }

        function toggleProfitDetails() {
            const checkbox = document.getElementById('showProfitDetails');
            const tableDiv = document.getElementById('profitDetailsTable');
            tableDiv.style.display = checkbox.checked ? 'block' : 'none';
        }

        function toggleChartLabels(chartId) {
            if (chartInstances[chartId]) {
                const chart = chartInstances[chartId];
                const showLabels = document.getElementById(
                    chartId === 'monthlyProfitChart' ? 'showMonthlyValues' :
                    chartId === 'topProductsChart' ? 'showTopProductValues' :
                    chartId === 'profitTypeChart' ? 'showProfitTypeValues' : 'showMarginTypeValues'
                ).checked;
                
                chart.options.plugins.datalabels.display = showLabels;
                chart.update();
            }
        }

        function renderProfitCharts() {
            renderMonthlyProfitChart();
            renderTopProductsChart();
            renderProfitByTypeChart();
            renderMarginByTypeChart();
        }

        function renderMonthlyProfitChart() {
            const ctx = document.getElementById('monthlyProfitChart');
            if (!ctx) {
                console.log('Canvas monthlyProfitChart not found');
                return;
            }

            // Group by month
            const monthlyData = {};
            profitData.forEach(item => {
                if (!monthlyData[item.month]) {
                    monthlyData[item.month] = { revenue: 0, cost: 0, profit: 0 };
                }
                monthlyData[item.month].revenue += item.total;
                monthlyData[item.month].cost += item.totalCost;
                monthlyData[item.month].profit += item.grossProfit;
            });

            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            const labels = months.filter(m => monthlyData[m]);
            
            if (labels.length === 0) {
                console.log('No data for monthly chart');
                return;
            }
            
            const revenues = labels.map(m => monthlyData[m].revenue);
            const costs = labels.map(m => monthlyData[m].cost);
            const profits = labels.map(m => monthlyData[m].profit);

            if (chartInstances['monthlyProfitChart']) {
                chartInstances['monthlyProfitChart'].destroy();
            }

            try {
                chartInstances['monthlyProfitChart'] = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [
                            {
                                label: 'Revenue',
                                data: revenues,
                                backgroundColor: 'rgba(59, 130, 246, 0.8)',
                                borderColor: 'rgb(59, 130, 246)',
                                borderWidth: 1
                            },
                            {
                                label: 'Cost',
                                data: costs,
                                backgroundColor: 'rgba(251, 146, 60, 0.8)',
                                borderColor: 'rgb(251, 146, 60)',
                                borderWidth: 1
                            },
                            {
                                label: 'Profit',
                                data: profits,
                                backgroundColor: 'rgba(34, 197, 94, 0.8)',
                                borderColor: 'rgb(34, 197, 94)',
                                borderWidth: 1
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: true, position: 'top' },
                            datalabels: {
                                display: true,
                                color: '#1f2937',
                                font: { weight: 'bold', size: 10 },
                                formatter: (value) => {
                                    if (!value || value === 0) return '';
                                    return value >= 1000000 ? '‡∏ø' + (value/1000000).toFixed(1) + 'M' : '‡∏ø' + (value/1000).toFixed(1) + 'K';
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: (value) => '‡∏ø' + (value/1000000).toFixed(1) + 'M'
                                }
                            }
                        }
                    }
                });
            } catch (error) {
                console.error('Error creating monthly profit chart:', error);
            }
        }

        function renderTopProductsChart() {
            const ctx = document.getElementById('topProductsChart');
            if (!ctx) {
                console.log('Canvas topProductsChart not found');
                return;
            }

            // Group by product
            const productData = {};
            profitData.forEach(item => {
                const productName = item.productName || item.description.split('(')[0].trim();
                if (!productData[productName]) {
                    productData[productName] = 0;
                }
                productData[productName] += item.grossProfit;
            });

            // Get top 10
            const sortedProducts = Object.entries(productData)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 10);

            if (sortedProducts.length === 0) {
                console.log('No data for top products chart');
                return;
            }

            const labels = sortedProducts.map(p => p[0].substring(0, 20));
            const data = sortedProducts.map(p => p[1]);

            if (chartInstances['topProductsChart']) {
                chartInstances['topProductsChart'].destroy();
            }

            try {
                chartInstances['topProductsChart'] = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Gross Profit',
                            data: data,
                            backgroundColor: 'rgba(34, 197, 94, 0.8)',
                            borderColor: 'rgb(34, 197, 94)',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        indexAxis: 'y',
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false },
                            datalabels: {
                                display: true,
                                color: '#1f2937',
                                font: { weight: 'bold', size: 10 },
                                anchor: 'end',
                                align: 'end',
                                formatter: (value) => {
                                    if (!value || value === 0) return '';
                                    return '‡∏ø' + (value/1000000).toFixed(1) + 'M';
                                }
                            }
                        },
                        scales: {
                            x: {
                                beginAtZero: true,
                                ticks: {
                                    callback: (value) => '‡∏ø' + (value/1000000).toFixed(0) + 'M'
                                }
                            }
                        }
                    }
                });
            } catch (error) {
                console.error('Error creating top products chart:', error);
            }
        }

        function renderProfitByTypeChart() {
            const ctx = document.getElementById('profitTypeChart');
            if (!ctx) {
                console.log('Canvas profitTypeChart not found');
                return;
            }

            // Group by product type
            const typeData = {};
            profitData.forEach(item => {
                if (!typeData[item.type]) {
                    typeData[item.type] = 0;
                }
                typeData[item.type] += item.grossProfit;
            });

            const sortedTypes = Object.entries(typeData)
                .sort((a, b) => b[1] - a[1]);

            if (sortedTypes.length === 0) {
                console.log('No data for profit by type chart');
                return;
            }

            const labels = sortedTypes.map(t => t[0]);
            const data = sortedTypes.map(t => t[1]);

            if (chartInstances['profitTypeChart']) {
                chartInstances['profitTypeChart'].destroy();
            }

            try {
                chartInstances['profitTypeChart'] = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Gross Profit (THB)',
                            data: data,
                            backgroundColor: 'rgba(59, 130, 246, 0.8)',
                            borderColor: 'rgb(59, 130, 246)',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false },
                            datalabels: {
                                display: true,
                                color: '#1f2937',
                                font: { weight: 'bold', size: 10 },
                                anchor: 'end',
                                align: 'end',
                                formatter: (value) => {
                                    if (!value || value === 0) return '';
                                    return value >= 1000000 ? '‡∏ø' + (value/1000000).toFixed(1) + 'M' : '‡∏ø' + (value/1000).toFixed(0) + 'M';
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: (value) => '‡∏ø' + (value/1000000).toFixed(0) + 'M'
                                }
                            }
                        }
                    }
                });
            } catch (error) {
                console.error('Error creating profit by type chart:', error);
            }
        }

        function renderMarginByTypeChart() {
            const ctx = document.getElementById('marginTypeChart');
            if (!ctx) {
                console.log('Canvas marginTypeChart not found');
                return;
            }

            // Calculate average margin by product type - ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì
            const typeData = {};
            profitData.forEach(item => {
                if (!typeData[item.type]) {
                    typeData[item.type] = { totalRevenue: 0, totalProfit: 0 };
                }
                typeData[item.type].totalRevenue += item.total;
                typeData[item.type].totalProfit += item.grossProfit;
            });

            // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì margin ‡∏à‡∏≤‡∏Å (Total Profit / Total Revenue) * 100 ‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏∞‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢ margin
            const sortedTypes = Object.entries(typeData)
                .map(([type, data]) => {
                    const margin = data.totalRevenue > 0 ? (data.totalProfit / data.totalRevenue) * 100 : 0;
                    return [type, margin];
                })
                .sort((a, b) => b[1] - a[1]);

            if (sortedTypes.length === 0) {
                console.log('No data for margin by type chart');
                return;
            }

            const labels = sortedTypes.map(t => t[0]);
            const data = sortedTypes.map(t => t[1]);

            if (chartInstances['marginTypeChart']) {
                chartInstances['marginTypeChart'].destroy();
            }

            try {
                chartInstances['marginTypeChart'] = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Profit Margin %',
                            data: data,
                            backgroundColor: data.map(v => v >= 50 ? 'rgba(34, 197, 94, 0.8)' : v >= 0 ? 'rgba(59, 130, 246, 0.8)' : 'rgba(239, 68, 68, 0.8)'),
                            borderColor: data.map(v => v >= 50 ? 'rgb(34, 197, 94)' : v >= 0 ? 'rgb(59, 130, 246)' : 'rgb(239, 68, 68)'),
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false },
                            datalabels: {
                                display: true,
                                color: '#1f2937',
                                font: { weight: 'bold', size: 10 },
                                anchor: 'end',
                                align: 'end',
                                formatter: (value) => {
                                    if (!value || value === 0) return '';
                                    return value.toFixed(1) + '%';
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: (value) => value + '%'
                                }
                            }
                        }
                    }
                });
            } catch (error) {
                console.error('Error creating margin by type chart:', error);
            }
        }

        function renderProfitTable() {
            const tbody = document.getElementById('profitTableBody');
            const sortedData = [...profitData].sort((a, b) => b.grossProfit - a.grossProfit);
            
            tbody.innerHTML = sortedData.map(item => {
                const profitClass = item.grossProfit >= 0 ? 'text-green-600' : 'text-red-600';
                const costClass = item.priceFound ? '' : 'bg-yellow-50 text-orange-600';
                const tooltip = !item.priceFound ? 'title="‚ö†Ô∏è Standard price not found"' : '';
                
                return `
                    <tr class="border-b border-gray-100 hover:bg-gray-50">
                        <td class="py-3 px-4">${item.month}</td>
                        <td class="py-3 px-4">${item.customer}</td>
                        <td class="py-3 px-4">${item.description}</td>
                        <td class="py-3 px-4 text-right">${item.qty.toLocaleString()}</td>
                        <td class="py-3 px-4 text-right">‡∏ø${item.total.toLocaleString()}</td>
                        <td class="py-3 px-4 text-right ${costClass}" ${tooltip}>
                            ${item.priceFound ? '‡∏ø' + item.totalCost.toLocaleString(undefined, {maximumFractionDigits: 0}) : '‡∏ø0 ‚ö†Ô∏è'}
                        </td>
                        <td class="py-3 px-4 text-right font-bold ${profitClass}">‡∏ø${item.grossProfit.toLocaleString(undefined, {maximumFractionDigits: 0})}</td>
                        <td class="py-3 px-4 text-right font-semibold ${profitClass}">${item.profitMargin.toFixed(2)}%</td>
                    </tr>
                `;
            }).join('');
        }

        function handleComparisonUpload(event, year) {
            const file = event.target.files[0];
            if (!file) return;

            showNotification('üìÇ Loading file...', 'success');

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    let text = e.target.result;
                    if (text.charCodeAt(0) === 0xFEFF) text = text.slice(1);
                    
                    const rows = parseCSV(text);
                    if (rows.length < 2) throw new Error('File appears to be empty');
                    
                    const data = rows.slice(1).filter(row => row.length >= 12).map(row => ({
                        marketType: row[0]?.trim() || '',
                        customerName: row[1]?.trim() || '',
                        productDescription: row[2]?.trim() || '',
                        industry: row[3]?.trim() || '',
                        country: row[4]?.trim() || '',
                        productType: row[5]?.trim() || '',
                        sales: row[6]?.trim() || '',
                        sellingPrice: parseFloat(row[7]) || 0,
                        standardPrice: parseFloat(row[8]) || 0,
                        totalAnnualQty: parseFloat(row[9]) || 0,
                        totalAnnualSales: parseFloat(row[10]) || 0,
                        grossProfitPercent: parseFloat(row[11]) || 0
                    }));
                    
                    comparisonData[year] = data;
                    
                    document.getElementById(`status-${year}`).innerHTML = `
                        <div class="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded-lg">
                            ‚úÖ Loaded ${data.length} records
                        </div>
                    `;
                    
                    showNotification(`‚úÖ ${year === 'year1' ? 'Year 1' : 'Year 2'} loaded!`, 'success');
                    
                    if (comparisonData.year1 && comparisonData.year2) {
                        updateComparison();
                    }
                    
                } catch (error) {
                    showNotification('‚ùå Error: ' + error.message, 'error');
                }
            };
            
            reader.readAsText(file, 'UTF-8');
            event.target.value = '';
        }

        function updateComparison() {
            if (!comparisonData.year1 || !comparisonData.year2) return;

            document.getElementById('comparisonResults').style.display = 'block';

            const totalRevY1 = comparisonData.year1.reduce((sum, item) => sum + item.totalAnnualSales, 0);
            const totalRevY2 = comparisonData.year2.reduce((sum, item) => sum + item.totalAnnualSales, 0);
            const totalQtyY1 = comparisonData.year1.reduce((sum, item) => sum + item.totalAnnualQty, 0);
            const totalQtyY2 = comparisonData.year2.reduce((sum, item) => sum + item.totalAnnualQty, 0);
            const ordersY1 = comparisonData.year1.length;
            const ordersY2 = comparisonData.year2.length;
            const avgMarginY1 = comparisonData.year1.reduce((sum, item) => sum + item.grossProfitPercent, 0) / ordersY1;
            const avgMarginY2 = comparisonData.year2.reduce((sum, item) => sum + item.grossProfitPercent, 0) / ordersY2;

            const revChange = totalRevY1 > 0 ? ((totalRevY2 - totalRevY1) / totalRevY1 * 100) : 0;
            const qtyChange = totalQtyY1 > 0 ? ((totalQtyY2 - totalQtyY1) / totalQtyY1 * 100) : 0;
            const ordersChange = ordersY1 > 0 ? ((ordersY2 - ordersY1) / ordersY1 * 100) : 0;
            const marginChange = avgMarginY2 - avgMarginY1;

            document.getElementById('compRevY1').textContent = `‡∏ø${(totalRevY1 / 1000000).toFixed(2)}M`;
            document.getElementById('compRevY2').textContent = `‡∏ø${(totalRevY2 / 1000000).toFixed(2)}M`;
            document.getElementById('compRevChange').textContent = `${revChange >= 0 ? '+' : ''}${revChange.toFixed(1)}%`;
            document.getElementById('compRevChange').className = `text-xl font-bold ${revChange >= 0 ? 'text-green-100' : 'text-red-100'}`;

            document.getElementById('compQtyY1').textContent = totalQtyY1.toLocaleString();
            document.getElementById('compQtyY2').textContent = totalQtyY2.toLocaleString();
            document.getElementById('compQtyChange').textContent = `${qtyChange >= 0 ? '+' : ''}${qtyChange.toFixed(1)}%`;
            document.getElementById('compQtyChange').className = `text-xl font-bold ${qtyChange >= 0 ? 'text-green-100' : 'text-red-100'}`;

            document.getElementById('compOrdersY1').textContent = ordersY1.toLocaleString();
            document.getElementById('compOrdersY2').textContent = ordersY2.toLocaleString();
            document.getElementById('compOrdersChange').textContent = `${ordersChange >= 0 ? '+' : ''}${ordersChange.toFixed(1)}%`;

            document.getElementById('compAvgY1').textContent = `‡∏ø${(totalRevY1/ordersY1).toLocaleString(undefined, {maximumFractionDigits: 0})}`;
            document.getElementById('compAvgY2').textContent = `‡∏ø${(totalRevY2/ordersY2).toLocaleString(undefined, {maximumFractionDigits: 0})}`;
            document.getElementById('compAvgChange').textContent = `${((totalRevY2/ordersY2 - totalRevY1/ordersY1)/(totalRevY1/ordersY1)*100).toFixed(1)}%`;

            document.getElementById('compMarginY1').textContent = `${avgMarginY1.toFixed(1)}%`;
            document.getElementById('compMarginY2').textContent = `${avgMarginY2.toFixed(1)}%`;
            document.getElementById('compMarginChange').textContent = `${marginChange >= 0 ? '+' : ''}${marginChange.toFixed(1)}%`;

            updateComparisonTable();
            showNotification('‚úÖ Comparison updated!', 'success');
        }

        function updateComparisonTable() {
            const tbody = document.getElementById('comparisonTableBody');
            
            const allProducts = new Map();
            
            comparisonData.year1.forEach(item => {
                const key = `${item.customerName}_${item.productDescription}`;
                if (!allProducts.has(key)) {
                    allProducts.set(key, { 
                        ...item,
                        qtyY1: item.totalAnnualQty,
                        salesY1: item.totalAnnualSales,
                        profitY1: item.grossProfitPercent,
                        qtyY2: 0,
                        salesY2: 0,
                        profitY2: 0
                    });
                }
            });

            comparisonData.year2.forEach(item => {
                const key = `${item.customerName}_${item.productDescription}`;
                if (allProducts.has(key)) {
                    const existing = allProducts.get(key);
                    existing.qtyY2 = item.totalAnnualQty;
                    existing.salesY2 = item.totalAnnualSales;
                    existing.profitY2 = item.grossProfitPercent;
                } else {
                    allProducts.set(key, {
                        ...item,
                        qtyY1: 0,
                        salesY1: 0,
                        profitY1: 0,
                        qtyY2: item.totalAnnualQty,
                        salesY2: item.totalAnnualSales,
                        profitY2: item.grossProfitPercent
                    });
                }
            });

            tbody.innerHTML = Array.from(allProducts.values()).map(item => `
                <tr class="border-b border-gray-100 hover:bg-gray-50">
                    <td class="py-3 px-2 text-sm">${item.marketType}</td>
                    <td class="py-3 px-2 text-sm">${item.customerName}</td>
                    <td class="py-3 px-2 text-sm">${item.productDescription}</td>
                    <td class="py-3 px-2 text-sm">${item.industry}</td>
                    <td class="py-3 px-2 text-sm">${item.country}</td>
                    <td class="py-3 px-2 text-sm">${item.productType}</td>
                    <td class="py-3 px-2 text-sm">${item.sales}</td>
                    <td class="py-3 px-2 text-right text-sm">‡∏ø${item.sellingPrice.toLocaleString()}</td>
                    <td class="py-3 px-2 text-right text-sm">‡∏ø${item.standardPrice.toLocaleString()}</td>
                    <td class="py-3 px-2 text-right text-sm">${item.qtyY1.toLocaleString()}</td>
                    <td class="py-3 px-2 text-right text-sm font-semibold">${item.qtyY2.toLocaleString()}</td>
                    <td class="py-3 px-2 text-right text-sm">‡∏ø${item.salesY1.toLocaleString(undefined, {maximumFractionDigits: 0})}</td>
                    <td class="py-3 px-2 text-right text-sm font-semibold">‡∏ø${item.salesY2.toLocaleString(undefined, {maximumFractionDigits: 0})}</td>
                    <td class="py-3 px-2 text-right text-sm">${item.profitY1.toFixed(2)}%</td>
                    <td class="py-3 px-2 text-right text-sm font-semibold">${item.profitY2.toFixed(2)}%</td>
                </tr>
            `).join('');
        }

        function exportComparison(format) {
            showNotification('‚úÖ Exporting...', 'success');
        }

        function handleFileUpload(event, type) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    let text = e.target.result;
                    if (text.charCodeAt(0) === 0xFEFF) text = text.slice(1);
                    
                    const rows = parseCSV(text);
                    if (rows.length < 2) throw new Error('Empty file');
                    
                    if (type === 'sales') {
                        salesData = rows.slice(1).filter(row => row.length >= 8).map(row => ({
                            month: row[0]?.trim() || '',
                            customer: row[1]?.trim() || '',
                            market: row[2]?.trim() || '',
                            description: row[3]?.trim() || '',
                            type: row[4]?.trim() || '',
                            qty: parseFloat(row[5]) || 0,
                            price: parseFloat(row[6]) || 0,
                            total: parseFloat(row[7]) || 0,
                            sales: row[8]?.trim() || ''
                        }));
                        filteredData = [...salesData];
                        renderSalesTable();
                        populateFilterOptions();
                        calculateProfitData();
                    } else if (type === 'prices') {
                        standardPrices = rows.slice(1).filter(row => row.length >= 2).map(row => ({
                            product: row[0]?.trim() || '',
                            standardPrice: parseFloat(row[1]) || 0
                        }));
                        renderPricesTable();
                        calculateProfitData();
                    } else if (type === 'customers') {
                        customers = rows.slice(1).filter(row => row.length >= 2).map(row => ({
                            name: row[0]?.trim() || '',
                            country: row[1]?.trim() || ''
                        }));
                        renderCustomersTable();
                    } else if (type === 'industry') {
                        industry = rows.slice(1).filter(row => row.length >= 2).map(row => ({
                            product: row[0]?.trim() || '',
                            industry: row[1]?.trim() || ''
                        }));
                        renderIndustryTable();
                        calculateProfitData();
                    }
                    
                    showNotification('‚úÖ Import successful!', 'success');
                } catch (error) {
                    showNotification('‚ùå Error: ' + error.message, 'error');
                }
            };
            
            reader.readAsText(file, 'UTF-8');
            event.target.value = '';
        }

        function downloadTemplate(type) {
            let template = '';
            let filename = '';
            
            if (type === 'sales') {
                template = 'Month,Customer Name,Market type,Description,Product Type,Quantity,Price,Total Price,Sales\nJan,Company Name,Domestic,"KERNIK KLD-101 (1,000KG)",Release Agent,1000,78,78000,Sales Person';
                filename = 'sales_template.csv';
            } else if (type === 'comparison') {
                template = 'Market Type,Customer Name,Product Description,Industry,Country,Product type,Sales,Selling Price,Standard price,Total Annual Qty,Total Annual Sales,Gross profit%\nDomestic,Company Name,"KERNIK KLD-101 (1,000KG)",Wood,Thailand,Release Agent,Sales Person,78,38,12000,936000,51.28';
                filename = 'comparison_template.csv';
            } else if (type === 'prices') {
                template = 'Product,Standard Price\nKERNIK ANTI-051/2 (1000kg),43';
                filename = 'prices_template.csv';
            } else if (type === 'customers') {
                template = 'Customer Name,Country\n‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó ABC ‡∏à‡∏≥‡∏Å‡∏±‡∏î,Thailand';
                filename = 'customers_template.csv';
            } else if (type === 'industry') {
                template = 'Product Name,Industry\nKERNIK ANTI-051/2 (1000kg),Wood';
                filename = 'industry_template.csv';
            }
            
            const BOM = '\uFEFF';
            const blob = new Blob([BOM + template], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = filename;
            link.click();
            
            showNotification('‚úÖ Template downloaded!', 'success');
        }

        function showTemplatePreview(type) {
            currentTemplateType = type;
            const modal = document.getElementById('templateModal');
            const modalTitle = document.getElementById('modalTitle');
            const modalContent = document.getElementById('modalContent');
            const downloadBtn = document.getElementById('modalDownloadBtn');
            
            let title = '';
            let content = '';
            
            if (type === 'comparison') {
                title = 'Comparison CSV Template';
                content = `
                    <div class="bg-blue-50 border-l-4 border-blue-500 p-4 mb-4">
                        <p class="text-blue-700 font-semibold">üìã Template Structure</p>
                        <p class="text-blue-600 text-sm mt-2">12 columns for year-over-year comparison data</p>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full border-collapse border border-gray-300 text-sm">
                            <thead>
                                <tr class="bg-gray-100">
                                    <th class="border border-gray-300 px-2 py-2 text-left font-semibold">Market Type</th>
                                    <th class="border border-gray-300 px-2 py-2 text-left font-semibold">Customer Name</th>
                                    <th class="border border-gray-300 px-2 py-2 text-left font-semibold">Product Description</th>
                                    <th class="border border-gray-300 px-2 py-2 text-left font-semibold">Industry</th>
                                    <th class="border border-gray-300 px-2 py-2 text-left font-semibold">Country</th>
                                    <th class="border border-gray-300 px-2 py-2 text-left font-semibold">Product type</th>
                                    <th class="border border-gray-300 px-2 py-2 text-left font-semibold">Sales</th>
                                    <th class="border border-gray-300 px-2 py-2 text-left font-semibold">Selling Price</th>
                                    <th class="border border-gray-300 px-2 py-2 text-left font-semibold">Standard price</th>
                                    <th class="border border-gray-300 px-2 py-2 text-left font-semibold">Total Annual Qty</th>
                                    <th class="border border-gray-300 px-2 py-2 text-left font-semibold">Total Annual Sales</th>
                                    <th class="border border-gray-300 px-2 py-2 text-left font-semibold">Gross profit%</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr class="bg-yellow-50">
                                    <td class="border border-gray-300 px-2 py-2">Domestic</td>
                                    <td class="border border-gray-300 px-2 py-2">Company Name</td>
                                    <td class="border border-gray-300 px-2 py-2">KERNIK KLD-101 (1,000KG)</td>
                                    <td class="border border-gray-300 px-2 py-2">Wood</td>
                                    <td class="border border-gray-300 px-2 py-2">Thailand</td>
                                    <td class="border border-gray-300 px-2 py-2">Release Agent</td>
                                    <td class="border border-gray-300 px-2 py-2">Sales Person</td>
                                    <td class="border border-gray-300 px-2 py-2">78</td>
                                    <td class="border border-gray-300 px-2 py-2">38</td>
                                    <td class="border border-gray-300 px-2 py-2">12000</td>
                                    <td class="border border-gray-300 px-2 py-2">936000</td>
                                    <td class="border border-gray-300 px-2 py-2">51.28</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                `;
            } else if (type === 'sales') {
                title = 'Sales Data Template';
                content = `
                    <div class="bg-blue-50 border-l-4 border-blue-500 p-4 mb-4">
                        <p class="text-blue-700 font-semibold">üìã Template Structure</p>
                        <p class="text-blue-600 text-sm mt-2">9 columns: Month, Customer Name, Market type, Description, Product Type, Quantity, Price, Total Price, Sales</p>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full border-collapse border border-gray-300">
                            <thead>
                                <tr class="bg-gray-100">
                                    <th class="border border-gray-300 px-4 py-2 text-left text-sm font-semibold">Month</th>
                                    <th class="border border-gray-300 px-4 py-2 text-left text-sm font-semibold">Customer Name</th>
                                    <th class="border border-gray-300 px-4 py-2 text-left text-sm font-semibold">Market type</th>
                                    <th class="border border-gray-300 px-4 py-2 text-left text-sm font-semibold">Description</th>
                                    <th class="border border-gray-300 px-4 py-2 text-left text-sm font-semibold">Product Type</th>
                                    <th class="border border-gray-300 px-4 py-2 text-left text-sm font-semibold">Quantity</th>
                                    <th class="border border-gray-300 px-4 py-2 text-left text-sm font-semibold">Price</th>
                                    <th class="border border-gray-300 px-4 py-2 text-left text-sm font-semibold">Total Price</th>
                                    <th class="border border-gray-300 px-4 py-2 text-left text-sm font-semibold">Sales</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr class="bg-yellow-50">
                                    <td class="border border-gray-300 px-4 py-2 text-sm">Jan</td>
                                    <td class="border border-gray-300 px-4 py-2 text-sm">Company Name</td>
                                    <td class="border border-gray-300 px-4 py-2 text-sm">Domestic</td>
                                    <td class="border border-gray-300 px-4 py-2 text-sm">KERNIK KLD-101 (1,000KG)</td>
                                    <td class="border border-gray-300 px-4 py-2 text-sm">Release Agent</td>
                                    <td class="border border-gray-300 px-4 py-2 text-sm">1000</td>
                                    <td class="border border-gray-300 px-4 py-2 text-sm">78</td>
                                    <td class="border border-gray-300 px-4 py-2 text-sm">78000</td>
                                    <td class="border border-gray-300 px-4 py-2 text-sm">Sales Person</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                `;
            } else if (type === 'prices') {
                title = 'Standard Prices Template';
                content = `
                    <div class="bg-blue-50 border-l-4 border-blue-500 p-4 mb-4">
                        <p class="text-blue-700 font-semibold">üìã Template Structure</p>
                        <p class="text-blue-600 text-sm mt-2">2 columns: Product, Standard Price</p>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full border-collapse border border-gray-300">
                            <thead>
                                <tr class="bg-gray-100">
                                    <th class="border border-gray-300 px-4 py-2 text-left text-sm font-semibold">Product</th>
                                    <th class="border border-gray-300 px-4 py-2 text-left text-sm font-semibold">Standard Price</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr class="bg-yellow-50">
                                    <td class="border border-gray-300 px-4 py-2 text-sm">KERNIK ANTI-051/2 (1000kg)</td>
                                    <td class="border border-gray-300 px-4 py-2 text-sm">43</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                `;
            } else if (type === 'customers') {
                title = 'Customer Details Template';
                content = `
                    <div class="bg-blue-50 border-l-4 border-blue-500 p-4 mb-4">
                        <p class="text-blue-700 font-semibold">üìã Template Structure</p>
                        <p class="text-blue-600 text-sm mt-2">2 columns: Customer Name, Country</p>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full border-collapse border border-gray-300">
                            <thead>
                                <tr class="bg-gray-100">
                                    <th class="border border-gray-300 px-4 py-2 text-left text-sm font-semibold">Customer Name</th>
                                    <th class="border border-gray-300 px-4 py-2 text-left text-sm font-semibold">Country</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr class="bg-yellow-50">
                                    <td class="border border-gray-300 px-4 py-2 text-sm">‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó ABC ‡∏à‡∏≥‡∏Å‡∏±‡∏î</td>
                                    <td class="border border-gray-300 px-4 py-2 text-sm">Thailand</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                `;
            } else if (type === 'industry') {
                title = 'Product Industry Template';
                content = `
                    <div class="bg-blue-50 border-l-4 border-blue-500 p-4 mb-4">
                        <p class="text-blue-700 font-semibold">üìã Template Structure</p>
                        <p class="text-blue-600 text-sm mt-2">2 columns: Product Name, Industry</p>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full border-collapse border border-gray-300">
                            <thead>
                                <tr class="bg-gray-100">
                                    <th class="border border-gray-300 px-4 py-2 text-left text-sm font-semibold">Product Name</th>
                                    <th class="border border-gray-300 px-4 py-2 text-left text-sm font-semibold">Industry</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr class="bg-yellow-50">
                                    <td class="border border-gray-300 px-4 py-2 text-sm">KERNIK ANTI-051/2 (1000kg)</td>
                                    <td class="border border-gray-300 px-4 py-2 text-sm">Wood</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                `;
            }
            
            modalTitle.textContent = title;
            modalContent.innerHTML = content;
            downloadBtn.onclick = () => downloadTemplate(currentTemplateType);
            
            modal.style.display = 'flex';
        }

        function closeTemplatePreview() {
            document.getElementById('templateModal').style.display = 'none';
        }

        function closeModal(event) {
            if (event.target.id === 'templateModal') {
                closeTemplatePreview();
            }
        }

        function renderSalesTable() {
            const tbody = document.getElementById('salesTableBody');
            if (!tbody) return;
            tbody.innerHTML = salesData.map(item => `
                <tr class="border-b border-gray-100 hover:bg-gray-50">
                    <td class="py-3 px-4">${item.month}</td>
                    <td class="py-3 px-4">${item.customer}</td>
                    <td class="py-3 px-4">${item.market}</td>
                    <td class="py-3 px-4">${item.description}</td>
                    <td class="py-3 px-4">${item.type}</td>
                    <td class="py-3 px-4 text-right">${item.qty.toLocaleString()}</td>
                    <td class="py-3 px-4 text-right">‡∏ø${item.price.toLocaleString()}</td>
                    <td class="py-3 px-4 text-right font-semibold">‡∏ø${item.total.toLocaleString()}</td>
                    <td class="py-3 px-4">${item.sales}</td>
                </tr>
            `).join('');
        }

        function renderPricesTable() {
            const tbody = document.getElementById('pricesTableBody');
            if (!tbody) return;
            tbody.innerHTML = standardPrices.map(item => `
                <tr class="border-b border-gray-100 hover:bg-gray-50">
                    <td class="py-3 px-4">${item.product}</td>
                    <td class="py-3 px-4 text-right font-semibold">‡∏ø${item.standardPrice.toLocaleString()}</td>
                </tr>
            `).join('');
        }

        function renderCustomersTable() {
            const tbody = document.getElementById('customersTableBody');
            if (!tbody) return;
            tbody.innerHTML = customers.map(item => `
                <tr class="border-b border-gray-100 hover:bg-gray-50">
                    <td class="py-3 px-4">${item.name}</td>
                    <td class="py-3 px-4">${item.country}</td>
                </tr>
            `).join('');
        }

        function renderIndustryTable() {
            const tbody = document.getElementById('industryTableBody');
            if (!tbody) return;
            tbody.innerHTML = industry.map(item => `
                <tr class="border-b border-gray-100 hover:bg-gray-50">
                    <td class="py-3 px-4">${item.product}</td>
                    <td class="py-3 px-4">${item.industry}</td>
                </tr>
            `).join('');
        }

        function exportData(type) {
            let data, filename;
            if (type === 'sales') {
                data = salesData;
                filename = 'sales-data.csv';
            } else if (type === 'prices') {
                data = standardPrices;
                filename = 'standard-prices.csv';
            } else if (type === 'customers') {
                data = customers;
                filename = 'customers.csv';
            } else if (type === 'industry') {
                data = industry;
                filename = 'industry.csv';
            }

            const headers = Object.keys(data[0]).join(',');
            const rows = data.map(obj => Object.values(obj).map(val => 
                typeof val === 'string' && (val.includes(',') || val.includes('"')) 
                    ? `"${val.replace(/"/g, '""')}"` 
                    : val
            ).join(','));
            const csv = [headers, ...rows].join('\n');
            
            const BOM = '\uFEFF';
            const blob = new Blob([BOM + csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = filename;
            link.click();
            
            showNotification('‚úÖ Export successful!', 'success');
        }

        function populateFilterOptions() {
            const months = [...new Set(salesData.map(item => item.month))].sort();
            const monthSelect = document.getElementById('filterMonth');
            if (monthSelect) {
                monthSelect.innerHTML = '<option value="all">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (All)</option>';
                months.forEach(month => {
                    const option = document.createElement('option');
                    option.value = month;
                    option.textContent = month;
                    monthSelect.appendChild(option);
                });
            }

            const productTypes = [...new Set(salesData.map(item => item.type))].sort();
            const productTypeSelect = document.getElementById('filterProductType');
            if (productTypeSelect) {
                productTypeSelect.innerHTML = '<option value="all">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (All)</option>';
                productTypes.forEach(type => {
                    const option = document.createElement('option');
                    option.value = type;
                    option.textContent = type;
                    productTypeSelect.appendChild(option);
                });
            }

            const industries = [...new Set(industry.map(item => item.industry))].sort();
            const industrySelect = document.getElementById('filterIndustry');
            if (industrySelect) {
                industrySelect.innerHTML = '<option value="all">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (All)</option>';
                industries.forEach(ind => {
                    const option = document.createElement('option');
                    option.value = ind;
                    option.textContent = ind;
                    industrySelect.appendChild(option);
                });
            }

            const salesPersons = [...new Set(salesData.map(item => item.sales))].sort();
            const salesPersonSelect = document.getElementById('filterSalesPerson');
            if (salesPersonSelect) {
                salesPersonSelect.innerHTML = '<option value="all">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (All)</option>';
                salesPersons.forEach(person => {
                    const option = document.createElement('option');
                    option.value = person;
                    option.textContent = person;
                    salesPersonSelect.appendChild(option);
                });
            }
        }

        function applyFilters() {
            const month = document.getElementById('filterMonth')?.value || 'all';
            const productType = document.getElementById('filterProductType')?.value || 'all';
            const market = document.getElementById('filterMarket')?.value || 'all';
            const salesPerson = document.getElementById('filterSalesPerson')?.value || 'all';

            filteredData = salesData.filter(item => {
                return (month === 'all' || item.month === month) &&
                       (productType === 'all' || item.type === productType) &&
                       (market === 'all' || item.market === market) &&
                       (salesPerson === 'all' || item.sales === salesPerson);
            });

            updateStats();
        }

        function resetFilters() {
            document.getElementById('filterMonth').value = 'all';
            document.getElementById('filterProductType').value = 'all';
            document.getElementById('filterIndustry').value = 'all';
            document.getElementById('filterMarket').value = 'all';
            document.getElementById('filterSalesPerson').value = 'all';
            filteredData = [...salesData];
            updateStats();
        }

        function updateStats() {
            const totalRev = filteredData.reduce((sum, item) => sum + item.total, 0);
            const totalQ = filteredData.reduce((sum, item) => sum + item.qty, 0);
            const avgOrder = filteredData.length > 0 ? totalRev / filteredData.length : 0;
            
            document.getElementById('totalRevenue').textContent = `‡∏ø${(totalRev / 1000000).toFixed(2)}M`;
            document.getElementById('totalQty').textContent = totalQ.toLocaleString();
            document.getElementById('totalOrders').textContent = filteredData.length;
            document.getElementById('avgOrderValue').textContent = `‡∏ø${Math.round(avgOrder).toLocaleString()}`;
        }

        function backupAllData() {
            const backup = {
                version: '2.0',
                timestamp: new Date().toISOString(),
                data: { salesData, standardPrices, customers, industry }
            };
            const blob = new Blob([JSON.stringify(backup, null, 2)], { type: 'application/json' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `backup-${new Date().toISOString().slice(0,10)}.json`;
            link.click();
            showNotification('‚úÖ Backup created', 'success');
        }

        function restoreFromBackup(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const backup = JSON.parse(e.target.result);
                    if (confirm('Restore backup? This will replace current data.')) {
                        salesData = backup.data.salesData;
                        standardPrices = backup.data.standardPrices || [];
                        customers = backup.data.customers || [];
                        industry = backup.data.industry || [];
                        filteredData = [...salesData];
                        calculateProfitData();
                        updateStats();
                        renderSalesTable();
                        showNotification('‚úÖ Backup restored', 'success');
                    }
                } catch (error) {
                    showNotification('‚ùå Invalid backup file', 'error');
                }
            };
            reader.readAsText(file);
            event.target.value = '';
        }

        // --- MODIFIED: Save to Firebase instead of LocalStorage ---
        async function saveData() {
            const dataToSave = {
                salesData: salesData,
                standardPrices: standardPrices,
                customers: customers,
                industry: industry,
                lastUpdated: new Date().toISOString(),
                updatedBy: 'Benz Dashboard Web'
            };
            
            if (window.saveToFirebase) {
                showNotification('‚è≥ Saving to Cloud...', 'success');
                await window.saveToFirebase(dataToSave);
                showNotification('‚úÖ Data synced to Cloud!', 'success');
            } else {
                // Fallback
                localStorage.setItem('salesDashboardData', JSON.stringify(dataToSave));
                showNotification('‚ö†Ô∏è Cloud not ready, saved locally', 'warning');
            }
        }

        function loadData() {
            // Deprecated for Cloud version, but kept as fallback for offline use
            try {
                const savedData = localStorage.getItem('salesDashboardData');
                if (savedData) {
                    const data = JSON.parse(savedData);
                    salesData = data.salesData || salesData;
                    standardPrices = data.standardPrices || standardPrices;
                    customers = data.customers || customers;
                    industry = data.industry || industry;
                    filteredData = [...salesData];
                    return true;
                }
                return false;
            } catch (error) {
                console.error('Error loading data:', error);
                return false;
            }
        }

        function clearData() {
            if (confirm('‚ö†Ô∏è Are you sure you want to clear all saved data? This cannot be undone.')) {
                try {
                    localStorage.removeItem('salesDashboardData');
                    
                    // Reset to default sample data
                    salesData = [
                        { month: 'Jan', customer: '‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó ‡∏£‡∏∞‡∏¢‡∏≠‡∏á MDF', market: 'Domestic', description: 'KERNIK KLD-101 (1,000KG)', type: 'Release Agent', qty: 1000, price: 78, total: 78000, sales: 'Chuthamas.S' },
                        { month: 'Jan', customer: '‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó ‡πÄ‡∏°‡πÇ‡∏ó‡∏£ MDF', market: 'Domestic', description: 'KERNIK KLD-101 (1,000KG)', type: 'Release Agent', qty: 2000, price: 78, total: 156000, sales: 'Chuthamas.S' },
                        { month: 'Feb', customer: 'Goodyear (Thailand)', market: 'Domestic', description: 'RimLube 928/45 (200KG)', type: 'Release Agent', qty: 9, price: 11026, total: 99234, sales: 'Natchaphon.K' }
                    ];
                    standardPrices = [
                        { product: 'KERNIK ANTI-051/2 (1000kg)', standardPrice: 43 },
                        { product: 'KERNIK KLD-GREEN-01 (1000kg)', standardPrice: 50.8 },
                        { product: 'KERNIK KLD-101 (1,000KG)', standardPrice: 38 }
                    ];
                    customers = [
                        { name: '‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó ‡∏ß‡∏ô‡∏ä‡∏±‡∏¢ ‡∏û‡∏≤‡πÄ‡∏ô‡∏•‡∏≠‡∏¥‡∏ô‡∏î‡∏±‡∏™‡∏ó‡∏£‡∏µ‡∏™‡πå‡∏à‡∏≥‡∏Å‡∏±‡∏î', country: 'Thailand' },
                        { name: '‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó ‡∏û‡∏≤‡πÄ‡∏ô‡∏• ‡∏û‡∏•‡∏±‡∏™ MDF ‡∏à‡∏≥‡∏Å‡∏±‡∏î', country: 'Thailand' },
                        { name: 'ACME INTER (VIETNAM) COMPANY LIMITED', country: 'Vietnam' }
                    ];
                    industry = [
                        { product: 'KERNIK ANTI-051/2 (1000kg)', industry: 'Wood' },
                        { product: 'KERNIK KLD-GREEN-01 (1000kg)', industry: 'Wood' },
                        { product: 'KERNIK KLO-022/11-H (18L)', industry: 'Rubber part' },
                        { product: 'RimLube 928/45 (200KG)', industry: 'Rubber tire' }
                    ];
                    
                    filteredData = [...salesData];
                    calculateProfitData();
                    updateStats();
                    renderSalesTable();
                    renderPricesTable();
                    renderCustomersTable();
                    renderIndustryTable();
                    
                    showNotification('‚úÖ Data cleared (Local only)', 'success');
                } catch (error) {
                    showNotification('‚ùå Error clearing data', 'error');
                }
            }
        }

        // Initialize
        window.addEventListener('DOMContentLoaded', function() {
            // Load saved data from localStorage first (as cache)
            const dataLoaded = loadData();
            
            if (dataLoaded) {
                // showNotification('‚úÖ Loaded cached data', 'success');
            }
            
            calculateProfitData();
            populateFilterOptions();
            updateStats();
            renderSalesTable();
            renderPricesTable();
            renderCustomersTable();
            renderIndustryTable();
            
            // Render dashboard charts after a short delay
            setTimeout(() => {
                renderDashboardCharts();
            }, 500);
        });
    </script>
</body>
</html>
